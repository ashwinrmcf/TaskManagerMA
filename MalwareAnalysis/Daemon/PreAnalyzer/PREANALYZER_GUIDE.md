# üîç PreAnalyzer - Process Scanner Guide

## What is PreAnalyzer?

**PreAnalyzer** is the first line of defense. It scans all running programs and identifies which ones might be dangerous.

Think of it like a security checkpoint that checks every person entering a building.

---

## How It Works

### Step 1: Collect All Processes
- Lists all programs currently running
- Gathers information about each one:
  - Process name
  - Process ID (PID)
  - File path
  - Command line arguments
  - CPU usage
  - Memory usage
  - Network connections

### Step 2: Check Whitelist
- Compares against list of safe programs
- Safe programs are skipped (no analysis needed)
- Suspicious programs move to next step

### Step 3: Analyze Suspicious Programs
- Checks program name for malware keywords
- Examines file path for suspicious locations
- Analyzes command line for suspicious commands
- Checks for suspicious network activity
- Calculates risk score (0-100)

### Step 4: Report Findings
- Lists all threats found
- Shows risk score and threat level
- Provides details about what makes it suspicious

---

## Understanding the Output

### Scan Summary
```
[14:06:34] Scanned 166 processes
[14:06:34] ‚úì No threats detected
```
**Meaning**: All 166 programs are safe

### Threat Detected
```
[14:06:34] üö® THREATS DETECTED: 1

PID      Name                    Threat          Score    Level
---------------------------------------------------------------------------
6776     python.exe              RANSOMWARE      80       CRITICAL
         ‚Üí Ransomware keyword: ransomware
         ‚Üí Ransomware keyword: ransomware_test
```

**What each column means**:
- **PID**: Process ID (unique number for this program)
- **Name**: Program name
- **Threat**: Type of threat detected
- **Score**: Danger level (0-100)
- **Level**: Severity (CRITICAL, HIGH, MEDIUM, LOW, SAFE)

---

## Threat Levels Explained

### üü¢ SAFE (Score: 0-30)
- No danger detected
- Program is whitelisted or has no suspicious indicators
- **Action**: None, continue monitoring

### üü° LOW (Score: 31-50)
- Minor suspicious signs
- Might be worth watching
- **Action**: Monitor, investigate if behavior changes

### üü† MEDIUM (Score: 51-70)
- Moderately suspicious
- Could be malware or legitimate program in temp folder
- **Action**: Investigate, may need manual review

### üî¥ HIGH (Score: 71-85)
- Very suspicious
- Strong indicators of malware
- **Action**: Prepare for automatic termination

### üî¥ CRITICAL (Score: 86-100)
- Definite threat
- Multiple malware indicators
- **Action**: Immediate automatic response

---

## What Makes a Program Suspicious?

### 1. Malware Keywords in Name
```
python.exe running "ransomware_test.py"
‚Üí Contains keyword: "ransomware"
‚Üí Risk Score: +40 points
```

### 2. Suspicious File Path
```
C:\Users\Public\Downloads\malware.exe
‚Üí Running from Downloads folder
‚Üí Risk Score: +15 points
```

### 3. Suspicious Command Line
```
powershell.exe -EncodedCommand JABzAD...
‚Üí Encoded commands (hides what it's doing)
‚Üí Risk Score: +20 points
```

### 4. Excessive Network Connections
```
Process has 125 network connections
‚Üí Unusual for normal programs
‚Üí Risk Score: +25 points
```

### 5. High CPU/Memory Usage
```
CPU: 95% | Memory: 80%
‚Üí Excessive resource usage
‚Üí Risk Score: +15 points
```

### 6. Process Injection
```
Code injected into another process
‚Üí Hiding malware inside legitimate program
‚Üí Risk Score: +30 points
```

---

## Whitelist - Safe Programs

**Whitelist** = List of programs we trust

### What's in the Whitelist?
- Windows system processes (system.exe, csrss.exe, etc.)
- Essential Windows services (svchost.exe, services.exe, etc.)
- Common legitimate programs (explorer.exe, dwm.exe, etc.)
- Installers (Windsurf, Python, Node, etc.)

### How to Add to Whitelist

Edit: `F:\MalwareAnalysis\Daemon\Config\essential_processes.txt`

Add your program name:
```
# My Safe Programs
my_safe_program.exe
my_script.py
```

Then restart the daemon.

---

## Grace Period - Avoiding Re-Detection

**Grace Period** = 30-second waiting period after threat is removed

### Why It Exists
- Prevents same threat from being detected multiple times
- Reduces false alerts
- Gives system time to stabilize

### How It Works
```
[14:06:36] [GRACE PERIOD] python.exe will be skipped for 30s
[14:06:40] Scanning processes...
[14:06:40] Skipping recently terminated threat: python.exe (grace period active)
[14:07:06] Grace period expired for: python.exe
[14:07:06] Now monitoring for this threat again
```

---

## Stale Process Detection

**Stale Process** = Process that's no longer actually running

### Problem It Solves
```
Old: python.exe (deleted script) still shows as running
New: Checks if script file actually exists
Result: Marked as STALE, not analyzed as threat
```

### Three-Layer Detection

1. **Layer 1**: Is the process PID still active?
2. **Layer 2**: Does the executable file exist?
3. **Layer 3**: For scripts, does the script file exist?

---

## Respawn Detection

**Respawn** = Malware that restarts itself

### How It's Detected
```
[14:16:03] ‚ö†Ô∏è  RESPAWNED THREAT DETECTED: python.exe (PID: 3220)
[14:16:03] This indicates the malware source has NOT been fully removed
```

### What It Means
- Threat was terminated
- Same threat appeared again
- Original source file might still exist
- Malware might have persistence mechanism

### What Happens
- Threat is terminated again
- File is quarantined again
- Investigation continues
- Parent process is checked

---

## Configuration

### Essential Processes File
```
F:\MalwareAnalysis\Daemon\Config\essential_processes.txt
```

**Format**:
```
# Comments start with #
process_name.exe
another_process
installer_name
```

**Case-Insensitive**: `windsurf` matches `WindsurfSetup-stable-...`

### Updating Whitelist
1. Open `essential_processes.txt`
2. Add program name (one per line)
3. Save file
4. Restart daemon
5. Program will be trusted

---

## Performance

### Scan Frequency
- Every 5 seconds
- Adjustable in code if needed

### Process Count
- Typically 150-200 processes
- Scan takes 1-2 seconds

### CPU Impact
- Minimal during normal operation
- Higher during memory dump/analysis

### Memory Impact
- ~50-100MB for PreAnalyzer
- Additional memory for dumps

---

## Troubleshooting

### Problem: Too Many False Positives

**Solution**:
1. Check what's being flagged
2. Add legitimate programs to whitelist
3. Review threat indicators

### Problem: Missing Threats

**Solution**:
1. Check if malware is in whitelist (remove if needed)
2. Check if malware is in grace period (wait 30 seconds)
3. Check if process is stale (verify executable exists)

### Problem: Slow Scanning

**Solution**:
1. Check CPU usage (may be analysis running)
2. Reduce process count (close unnecessary programs)
3. Check disk I/O (may be dump writing)

---

## Key Indicators

### High Risk Indicators
- Ransomware keywords
- Process injection
- Encoded commands
- Suspicious network activity
- Excessive resource usage

### Medium Risk Indicators
- Temp folder execution
- Unknown process
- Suspicious file extension
- Registry modification attempts

### Low Risk Indicators
- Unusual but not malicious
- Legitimate program in unusual location
- High resource usage (mining)

---

## Summary

| Aspect | Details |
|--------|---------|
| **Purpose** | Scan and identify threats |
| **Frequency** | Every 5 seconds |
| **Processes Scanned** | 150-200 typical |
| **Scan Time** | 1-2 seconds |
| **Threat Levels** | 5 levels (SAFE to CRITICAL) |
| **Grace Period** | 30 seconds |
| **Whitelist** | 784+ safe programs |
| **Detection Methods** | 10 layers of analysis |

---

**Version**: 1.0  
**Status**: Production Ready ‚úÖ
