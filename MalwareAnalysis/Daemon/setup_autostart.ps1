# ============================================================================
# Malware Analysis Daemon - Auto-Start Setup
# This script configures the daemon to start automatically on PC boot
# ============================================================================

# Run as Administrator check
if (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Write-Host "ERROR: This script must be run as Administrator!" -ForegroundColor Red
    Write-Host "Please right-click PowerShell and select 'Run as Administrator'" -ForegroundColor Yellow
    Read-Host "Press Enter to exit"
    exit
}

Write-Host "============================================================================" -ForegroundColor Cyan
Write-Host "Malware Analysis Daemon - Auto-Start Setup" -ForegroundColor Cyan
Write-Host "============================================================================" -ForegroundColor Cyan
Write-Host ""

# Paths
$daemonRoot = "F:\MalwareAnalysis\Daemon"
$startupBat = "$daemonRoot\start_daemon_on_startup.bat"
$startupFolder = "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup"
$shortcutPath = "$startupFolder\Start_Malware_Daemon.lnk"

# Verify daemon exists
if (-not (Test-Path $daemonRoot)) {
    Write-Host "ERROR: Daemon directory not found: $daemonRoot" -ForegroundColor Red
    Read-Host "Press Enter to exit"
    exit
}

Write-Host "Setting up auto-start for Malware Analysis Daemon..." -ForegroundColor Yellow
Write-Host ""

# Method 1: Create Startup Folder Shortcut
Write-Host "[1/2] Creating startup shortcut..." -ForegroundColor Cyan

try {
    # Create shortcut using COM object
    $WshShell = New-Object -ComObject WScript.Shell
    $Shortcut = $WshShell.CreateShortcut($shortcutPath)
    $Shortcut.TargetPath = $startupBat
    $Shortcut.WorkingDirectory = $daemonRoot
    $Shortcut.Description = "Malware Analysis Daemon - Auto-Start"
    $Shortcut.WindowStyle = 1  # Normal window
    $Shortcut.Save()
    
    Write-Host "✓ Startup shortcut created: $shortcutPath" -ForegroundColor Green
} catch {
    Write-Host "✗ Failed to create shortcut: $_" -ForegroundColor Red
}

# Method 2: Add to Registry (Task Scheduler alternative)
Write-Host "[2/2] Adding to Windows Registry..." -ForegroundColor Cyan

try {
    $regPath = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"
    $regName = "MalwareAnalyzerDaemon"
    $regValue = $startupBat
    
    # Create registry entry
    New-ItemProperty -Path $regPath -Name $regName -Value $regValue -PropertyType String -Force | Out-Null
    
    Write-Host "✓ Registry entry created" -ForegroundColor Green
} catch {
    Write-Host "✗ Failed to create registry entry: $_" -ForegroundColor Red
}

Write-Host ""
Write-Host "============================================================================" -ForegroundColor Cyan
Write-Host "Setup Complete!" -ForegroundColor Green
Write-Host "============================================================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "The daemon will now start automatically when you:" -ForegroundColor Yellow
Write-Host "  1. Restart your PC" -ForegroundColor White
Write-Host "  2. Log in to Windows" -ForegroundColor White
Write-Host ""
Write-Host "Startup Methods Enabled:" -ForegroundColor Cyan
Write-Host "  ✓ Startup Folder Shortcut: $shortcutPath" -ForegroundColor Green
Write-Host "  ✓ Windows Registry Entry: HKCU\Software\Microsoft\Windows\CurrentVersion\Run" -ForegroundColor Green
Write-Host ""
Write-Host "To disable auto-start later:" -ForegroundColor Yellow
Write-Host "  Option 1: Delete the shortcut from Startup folder" -ForegroundColor White
Write-Host "  Option 2: Remove registry entry using regedit" -ForegroundColor White
Write-Host "  Option 3: Run 'disable_autostart.ps1'" -ForegroundColor White
Write-Host ""
Write-Host "Daemon will run in a new window titled: 'Malware Analysis Daemon'" -ForegroundColor Cyan
Write-Host ""

Read-Host "Press Enter to exit"
