"""
Memory Dumper Component - Comprehensive Test Suite
Tests all dump strategies, countdown, and integration
"""

import sys
import json
from pathlib import Path
from datetime import datetime

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent))

from advanced_memory_dumper import (
    AdvancedMemoryDumper, ThreatType, DumpStrategy
)
from memory_dump_integration import MemoryDumpIntegration, DumpStrategyAnalyzer
from dump_countdown import DumpCountdown, CountdownManager, display_workflow_summary


def print_header(title):
    """Print formatted header"""
    print("\n" + "="*80)
    print(f"  {title}")
    print("="*80 + "\n")


def test_dump_strategies():
    """Test all 5 dump strategies"""
    print_header("TEST 1: DUMP STRATEGY SELECTION")
    
    dumper = AdvancedMemoryDumper()
    
    test_cases = [
        (ThreatType.RANSOMWARE, "CRITICAL", "Ransomware"),
        (ThreatType.ROOTKIT, "CRITICAL", "Rootkit"),
        (ThreatType.BOTNET, "CRITICAL", "Botnet"),
        (ThreatType.TROJAN, "HIGH", "Trojan"),
        (ThreatType.SPYWARE, "HIGH", "Spyware"),
        (ThreatType.WORM, "MEDIUM", "Worm"),
        (ThreatType.UNKNOWN, "LOW", "Unknown"),
    ]
    
    for threat_type, threat_level, name in test_cases:
        strategy = dumper.determine_dump_strategy(threat_type, threat_level)
        print(f"‚úì {name:15} ({threat_level:8}) ‚Üí {strategy.value:20}")
    
    print("\n‚úÖ Strategy selection test PASSED\n")


def test_full_dump_creation():
    """Test creating actual memory dumps"""
    print_header("TEST 2: MEMORY DUMP CREATION")
    
    dumper = AdvancedMemoryDumper()
    
    # Test ransomware dump
    print("Creating ransomware dump (TARGETED_KERNEL)...")
    metadata = dumper.create_dump(
        threat_type=ThreatType.RANSOMWARE,
        threat_level="CRITICAL",
        malicious_pids=[1234, 5678],
        threat_name="test_ransomware"
    )
    
    print(f"‚úì Dump created: {metadata['dump_files']}")
    print(f"‚úì Strategy: {metadata['strategy']}")
    print(f"‚úì Size: {metadata.get('dump_size_gb', 'N/A')}GB")
    print(f"‚úì Volatility Profile: {metadata['volatility_profile']}")
    print(f"‚úì Analysis Commands: {len(metadata['analysis_commands'])} commands")
    
    print("\n‚úÖ Dump creation test PASSED\n")


def test_countdown_timer():
    """Test countdown timer"""
    print_header("TEST 3: COUNTDOWN TIMER (5 seconds)")
    
    countdown = DumpCountdown(countdown_seconds=5)
    
    threat_info = {
        'threat_name': 'test_malware.exe',
        'threat_type': 'RANSOMWARE',
        'threat_level': 'CRITICAL',
        'risk_score': 85,
        'quarantine_path': 'F:/MalwareAnalysis/Daemon/Quarantine/test'
    }
    
    print("Starting 5-second countdown...\n")
    success = countdown.start_countdown(threat_info)
    
    if success:
        print("\n‚úÖ Countdown test PASSED\n")
    else:
        print("\n‚ö†Ô∏è  Countdown interrupted\n")


def test_integration_workflow():
    """Test complete integration workflow"""
    print_header("TEST 4: INTEGRATION WORKFLOW")
    
    integration = MemoryDumpIntegration()
    
    # Simulate threat from PreAnalyzer
    threat_info = {
        'threat_type': 'RANSOMWARE',
        'threat_level': 'CRITICAL',
        'risk_score': 85,
        'indicators': ['Ransomware keyword: ransomware', 'Shadow copy deletion'],
        'pid': 1234,
        'name': 'ransomware_test.py',
        'path': 'f:/MalwareAnalysis/ProcessManager/ransomware_test.py',
        'cmdline': 'python ransomware_test.py',
        'confidence': 0.95
    }
    
    print("Processing threat detection...")
    result = integration.process_threat_detection(threat_info)
    
    print(f"‚úì Threat Name: {result['threat_name']}")
    print(f"‚úì Threat Type: {result['threat_type']}")
    print(f"‚úì Strategy: {result['strategy']}")
    print(f"‚úì Dump Files: {len(result['dump_files'])} file(s)")
    print(f"‚úì Analysis Script: {result.get('analysis_script', 'N/A')}")
    
    print("\n‚úÖ Integration workflow test PASSED\n")


def test_efficiency_analysis():
    """Test dump strategy efficiency analysis"""
    print_header("TEST 5: EFFICIENCY ANALYSIS")
    
    analyzer = DumpStrategyAnalyzer()
    
    dump_metadata = {
        'strategy': 'targeted_kernel',
        'threat_type': 'ransomware',
        'threat_level': 'CRITICAL',
        'dump_size_gb': 3,
        'analysis_commands': ['volatility -f dump.raw imageinfo']
    }
    
    efficiency = analyzer.analyze_dump_efficiency(dump_metadata)
    
    print(f"‚úì Strategy: {efficiency['strategy']}")
    print(f"‚úì Threat Type: {efficiency['threat_type']}")
    print(f"‚úì Efficiency Score: {efficiency['efficiency_score']}/100")
    
    if efficiency['recommendations']:
        print(f"‚úì Recommendations:")
        for rec in efficiency['recommendations']:
            print(f"  - {rec}")
    else:
        print(f"‚úì No optimization needed")
    
    print("\n‚úÖ Efficiency analysis test PASSED\n")


def test_countdown_workflow():
    """Test complete countdown workflow"""
    print_header("TEST 6: COUNTDOWN WORKFLOW (Quarantine ‚Üí Countdown ‚Üí Dump)")
    
    manager = CountdownManager(countdown_seconds=5)
    integration = MemoryDumpIntegration()
    
    threat_info = {
        'threat_name': 'workflow_test.exe',
        'threat_type': 'TROJAN',
        'threat_level': 'HIGH',
        'risk_score': 72
    }
    
    print("Executing complete workflow...\n")
    
    result = manager.execute_quarantine_dump_workflow(
        threat_info=threat_info,
        dump_callback=lambda info: integration.process_threat_detection(info)
    )
    
    # Display summary
    display_workflow_summary(result)
    
    print("‚úÖ Workflow test PASSED\n")


def test_all_threat_types():
    """Test all threat types"""
    print_header("TEST 7: ALL THREAT TYPES")
    
    integration = MemoryDumpIntegration()
    
    threat_types = [
        ('RANSOMWARE', 'CRITICAL', 'Ransomware threat'),
        ('TROJAN', 'HIGH', 'Trojan threat'),
        ('SPYWARE', 'HIGH', 'Spyware threat'),
        ('ROOTKIT', 'CRITICAL', 'Rootkit threat'),
        ('BOTNET', 'CRITICAL', 'Botnet threat'),
        ('WORM', 'HIGH', 'Worm threat'),
    ]
    
    for threat_type, level, description in threat_types:
        threat_info = {
            'threat_type': threat_type,
            'threat_level': level,
            'risk_score': 80,
            'indicators': [f'{threat_type} detected'],
            'pid': 1234,
            'name': f'test_{threat_type.lower()}.exe',
            'path': f'C:/test_{threat_type.lower()}.exe',
            'cmdline': f'test_{threat_type.lower()}.exe',
            'confidence': 0.95
        }
        
        result = integration.process_threat_detection(threat_info)
        print(f"‚úì {description:20} ‚Üí {result['strategy']:20}")
    
    print("\n‚úÖ All threat types test PASSED\n")


def test_output_files():
    """Test output file generation"""
    print_header("TEST 8: OUTPUT FILE VERIFICATION")
    
    base_path = Path("F:/MalwareAnalysis/MemoryDumps")
    
    directories = [
        base_path / "FullSystemDumps",
        base_path / "TargetedDumps",
        base_path / "ProcessDumps",
        base_path / "MinimalDumps",
        base_path / "LiveResponse",
        base_path / "IntegrationReports",
        base_path / "AnalysisScripts",
    ]
    
    print("Checking output directories...\n")
    
    for dir_path in directories:
        if dir_path.exists():
            file_count = len(list(dir_path.glob('*')))
            print(f"‚úì {dir_path.name:25} - {file_count} file(s)")
        else:
            print(f"‚úó {dir_path.name:25} - NOT FOUND")
    
    print("\n‚úÖ Output file test PASSED\n")


def run_all_tests():
    """Run all tests"""
    print("\n")
    print("‚ïî" + "="*78 + "‚ïó")
    print("‚ïë" + " "*78 + "‚ïë")
    print("‚ïë" + "  MEMORY DUMPER COMPONENT - COMPREHENSIVE TEST SUITE".center(78) + "‚ïë")
    print("‚ïë" + " "*78 + "‚ïë")
    print("‚ïö" + "="*78 + "‚ïù")
    
    tests = [
        ("Strategy Selection", test_dump_strategies),
        ("Dump Creation", test_full_dump_creation),
        ("Countdown Timer", test_countdown_timer),
        ("Integration Workflow", test_integration_workflow),
        ("Efficiency Analysis", test_efficiency_analysis),
        ("Countdown Workflow", test_countdown_workflow),
        ("All Threat Types", test_all_threat_types),
        ("Output Files", test_output_files),
    ]
    
    passed = 0
    failed = 0
    
    for test_name, test_func in tests:
        try:
            test_func()
            passed += 1
        except Exception as e:
            print(f"\n‚ùå {test_name} FAILED: {e}\n")
            failed += 1
    
    # Final summary
    print_header("TEST SUMMARY")
    print(f"Total Tests: {len(tests)}")
    print(f"‚úÖ Passed: {passed}")
    print(f"‚ùå Failed: {failed}")
    print(f"Success Rate: {(passed/len(tests)*100):.1f}%")
    
    if failed == 0:
        print("\nüéâ ALL TESTS PASSED! üéâ\n")
    else:
        print(f"\n‚ö†Ô∏è  {failed} test(s) failed\n")
    
    print("="*80 + "\n")


if __name__ == "__main__":
    run_all_tests()
