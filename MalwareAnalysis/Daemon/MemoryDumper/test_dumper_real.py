#!/usr/bin/env python3
"""Test MemoryDumper on a real running process"""

import sys
import psutil
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent))

from advanced_memory_dumper import AdvancedMemoryDumper, ThreatType

def main():
    print("\n" + "="*80)
    print("MEMORY DUMPER TEST - Real Process Dump")
    print("="*80 + "\n")
    
    # Initialize dumper
    dumper = AdvancedMemoryDumper()
    
    # Find a real process to dump (use notepad or explorer)
    target_process = None
    for proc in psutil.process_iter(['pid', 'name']):
        try:
            if proc.info['name'].lower() in ['notepad.exe', 'explorer.exe', 'python.exe']:
                target_process = proc.info
                break
        except:
            pass
    
    if not target_process:
        print("ERROR: No suitable process found to dump")
        print("Available processes:")
        for proc in psutil.process_iter(['pid', 'name']):
            try:
                print(f"  - {proc.info['name']} (PID: {proc.info['pid']})")
            except:
                pass
        return
    
    print(f"Target process: {target_process['name']} (PID: {target_process['pid']})")
    print(f"Dump strategy: PROCESS_SPECIFIC")
    print(f"Threat type: UNKNOWN\n")
    
    # Create dump
    print("Creating memory dump...")
    try:
        metadata = dumper.create_dump(
            threat_type=ThreatType.UNKNOWN,
            threat_level="LOW",
            malicious_pids=[target_process['pid']],
            threat_name=target_process['name'].replace('.exe', '')
        )
        
        print("\n" + "="*80)
        print("DUMP COMPLETE")
        print("="*80)
        print(f"Dump files created: {len(metadata.get('dump_files', []))}")
        print(f"Total size: {metadata.get('total_size_mb', 0):.2f} MB")
        print(f"Strategy: {metadata.get('strategy', 'unknown')}")
        print(f"Output directory: {metadata.get('output_dir', 'unknown')}")
        
        if metadata.get('dump_files'):
            print(f"\nDump files:")
            for dump_file in metadata['dump_files']:
                print(f"  - {dump_file}")
        
        print(f"\nMetadata saved to: {metadata.get('metadata_file', 'unknown')}")
        
    except Exception as e:
        print(f"ERROR during dump: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    main()
