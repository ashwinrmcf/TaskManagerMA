# Memory Dumper Component - PowerShell Test Script
# Complete testing workflow with all commands

Write-Host "`n" -ForegroundColor Green
Write-Host "================================================================================" -ForegroundColor Cyan
Write-Host "                                                                                " -ForegroundColor Cyan
Write-Host "              MEMORY DUMPER COMPONENT - POWERSHELL TEST SUITE                  " -ForegroundColor Cyan
Write-Host "                                                                                " -ForegroundColor Cyan
Write-Host "================================================================================" -ForegroundColor Cyan
Write-Host "`n"

# Step 1: Navigate to directory
Write-Host "[STEP 1] Navigating to MemoryDumper directory..." -ForegroundColor Yellow
$dumperPath = "f:\MalwareAnalysis\Daemon\MemoryDumper"

if (Test-Path $dumperPath) {
    Set-Location $dumperPath
    Write-Host "[OK] Current directory: $(Get-Location)" -ForegroundColor Green
} else {
    Write-Host "[ERROR] Directory not found: $dumperPath" -ForegroundColor Red
    exit 1
}

Write-Host "`n"

# Step 2: Check Python installation
Write-Host "[STEP 2] Checking Python installation..." -ForegroundColor Yellow
$pythonVersion = python --version 2>&1
if ($LASTEXITCODE -eq 0) {
    Write-Host "[OK] Python found: $pythonVersion" -ForegroundColor Green
} else {
    Write-Host "[ERROR] Python not found or not in PATH" -ForegroundColor Red
    exit 1
}

Write-Host "`n"

# Step 3: Check required modules
Write-Host "[STEP 3] Checking required Python modules..." -ForegroundColor Yellow
$modules = @("psutil", "pathlib", "json", "datetime")

foreach ($module in $modules) {
    $check = python -c "import $module" 2>&1
    if ($LASTEXITCODE -eq 0) {
        Write-Host "[OK] Module '$module' found" -ForegroundColor Green
    } else {
        Write-Host "[WARN] Module '$module' may not be available" -ForegroundColor Yellow
    }
}

Write-Host "`n"

# Step 4: List test files
Write-Host "[STEP 4] Checking test files..." -ForegroundColor Yellow
$testFiles = @(
    "test_memory_dumper.py",
    "advanced_memory_dumper.py",
    "memory_dump_integration.py",
    "dump_countdown.py",
    "__init__.py"
)

foreach ($file in $testFiles) {
    if (Test-Path $file) {
        $size = (Get-Item $file).Length / 1024
        $sizeRounded = [Math]::Round($size, 2)
        Write-Host "[OK] $file ($sizeRounded KB)" -ForegroundColor Green
    } else {
        Write-Host "[ERROR] $file NOT FOUND" -ForegroundColor Red
    }
}

Write-Host "`n"

# Step 5: Run comprehensive tests
Write-Host "[STEP 5] Running comprehensive test suite..." -ForegroundColor Yellow
Write-Host "This will test all dump strategies, countdown, and integration..." -ForegroundColor Cyan
Write-Host "`n"

python test_memory_dumper.py

Write-Host "`n"

# Step 6: Check output directories
Write-Host "[STEP 6] Verifying output directories..." -ForegroundColor Yellow
$outputBase = "F:\MalwareAnalysis\MemoryDumps"
$dirs = @(
    "FullSystemDumps",
    "TargetedDumps",
    "ProcessDumps",
    "MinimalDumps",
    "LiveResponse",
    "IntegrationReports",
    "AnalysisScripts"
)

foreach ($dir in $dirs) {
    $fullPath = Join-Path $outputBase $dir
    if (Test-Path $fullPath) {
        $fileCount = (Get-ChildItem $fullPath -ErrorAction SilentlyContinue | Measure-Object).Count
        Write-Host "[OK] $dir ($fileCount files)" -ForegroundColor Green
    } else {
        Write-Host "[WARN] $dir not found (will be created on first dump)" -ForegroundColor Yellow
    }
}

Write-Host "`n"

# Step 7: Summary
Write-Host "================================================================================" -ForegroundColor Cyan
Write-Host "                          TEST EXECUTION COMPLETE                               " -ForegroundColor Cyan
Write-Host "================================================================================" -ForegroundColor Cyan

Write-Host "`nTest Summary:" -ForegroundColor Yellow
Write-Host "  [OK] Python environment verified" -ForegroundColor Green
Write-Host "  [OK] Required modules checked" -ForegroundColor Green
Write-Host "  [OK] Test files located" -ForegroundColor Green
Write-Host "  [OK] Comprehensive tests executed" -ForegroundColor Green
Write-Host "  [OK] Output directories verified" -ForegroundColor Green

Write-Host "`nNext Steps:" -ForegroundColor Cyan
Write-Host "  1. Review test output above" -ForegroundColor White
Write-Host "  2. Check MemoryDumps/ directory for generated files" -ForegroundColor White
Write-Host "  3. Review logs in MemoryDumps/IntegrationReports/" -ForegroundColor White
Write-Host "  4. Integrate with PreAnalyzer in enhanced_pre_analyzer_monitor.py" -ForegroundColor White

Write-Host "`n"
