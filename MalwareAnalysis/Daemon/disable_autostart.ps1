# ============================================================================
# Malware Analysis Daemon - Disable Auto-Start
# This script removes the daemon from auto-start
# ============================================================================

# Run as Administrator check
if (-NOT ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Write-Host "ERROR: This script must be run as Administrator!" -ForegroundColor Red
    Write-Host "Please right-click PowerShell and select 'Run as Administrator'" -ForegroundColor Yellow
    Read-Host "Press Enter to exit"
    exit
}

Write-Host "============================================================================" -ForegroundColor Cyan
Write-Host "Malware Analysis Daemon - Disable Auto-Start" -ForegroundColor Cyan
Write-Host "============================================================================" -ForegroundColor Cyan
Write-Host ""

# Paths
$startupFolder = "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup"
$shortcutPath = "$startupFolder\Start_Malware_Daemon.lnk"

Write-Host "Disabling auto-start for Malware Analysis Daemon..." -ForegroundColor Yellow
Write-Host ""

# Method 1: Remove Startup Folder Shortcut
Write-Host "[1/2] Removing startup shortcut..." -ForegroundColor Cyan

try {
    if (Test-Path $shortcutPath) {
        Remove-Item $shortcutPath -Force
        Write-Host "✓ Startup shortcut removed: $shortcutPath" -ForegroundColor Green
    } else {
        Write-Host "ℹ Startup shortcut not found (already removed)" -ForegroundColor Yellow
    }
} catch {
    Write-Host "✗ Failed to remove shortcut: $_" -ForegroundColor Red
}

# Method 2: Remove from Registry
Write-Host "[2/2] Removing from Windows Registry..." -ForegroundColor Cyan

try {
    $regPath = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"
    $regName = "MalwareAnalyzerDaemon"
    
    # Check if entry exists
    $regEntry = Get-ItemProperty -Path $regPath -Name $regName -ErrorAction SilentlyContinue
    
    if ($regEntry) {
        Remove-ItemProperty -Path $regPath -Name $regName -Force
        Write-Host "✓ Registry entry removed" -ForegroundColor Green
    } else {
        Write-Host "ℹ Registry entry not found (already removed)" -ForegroundColor Yellow
    }
} catch {
    Write-Host "✗ Failed to remove registry entry: $_" -ForegroundColor Red
}

Write-Host ""
Write-Host "============================================================================" -ForegroundColor Cyan
Write-Host "Auto-Start Disabled!" -ForegroundColor Green
Write-Host "============================================================================" -ForegroundColor Cyan
Write-Host ""
Write-Host "The daemon will NO LONGER start automatically on PC boot." -ForegroundColor Yellow
Write-Host ""
Write-Host "To manually start the daemon:" -ForegroundColor Cyan
Write-Host "  python F:\MalwareAnalysis\Daemon\enhanced_pre_analyzer_monitor.py" -ForegroundColor White
Write-Host ""
Write-Host "To re-enable auto-start:" -ForegroundColor Cyan
Write-Host "  Run 'setup_autostart.ps1' again" -ForegroundColor White
Write-Host ""

Read-Host "Press Enter to exit"
