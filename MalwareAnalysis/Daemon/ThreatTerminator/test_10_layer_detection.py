#!/usr/bin/env python3
"""Test 10-Layer Detection in Enhanced Threat Terminator"""

import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent))

from enhanced_threat_terminator import EnhancedThreatTerminator

def main():
    print("\n" + "="*80)
    print("10-LAYER DETECTION TEST")
    print("="*80 + "\n")
    
    terminator = EnhancedThreatTerminator()
    
    # Create a test malicious file with multiple threat indicators
    test_file = Path("f:\\MalwareAnalysis\\ProcessManager\\test_10layer_malware.py")
    
    test_content = """
# Ransomware payload
import socket
import subprocess

# C2 Communication
def connect_c2():
    sock = socket.socket()
    sock.connect(('185.220.101.1', 4444))
    
# File encryption
def encrypt_files():
    import os
    for file in os.listdir('C:\\Users'):
        os.remove(file)
        
# Registry modification
def modify_registry():
    subprocess.run('reg add HKLM\\\\Run /v Malware', shell=True)
    
# Shadow copy deletion
def delete_shadows():
    subprocess.run('vssadmin delete shadows /all', shell=True)

encrypt_files()
connect_c2()
modify_registry()
delete_shadows()
"""
    
    # Write test file
    test_file.parent.mkdir(parents=True, exist_ok=True)
    test_file.write_text(test_content)
    
    print(f"Created test malware file: {test_file.name}\n")
    
    # Run 10-layer detection
    results = terminator.run_all_detection_layers(str(test_file))
    
    print(f"\n{'='*80}")
    print("DETECTION RESULTS")
    print(f"{'='*80}\n")
    
    print(f"Total Threats Detected: {results['total_threats']}\n")
    
    # Display results by layer
    for layer_name, threats in results['layer_results'].items():
        if threats:
            print(f"{layer_name}:")
            for threat in threats:
                print(f"  â€¢ {threat['type']} [{threat['severity']}]")
                print(f"    Indicator: {threat['indicator']}")
    
    # Cleanup
    try:
        test_file.unlink()
        print(f"\nCleaned up test file")
    except:
        pass
    
    print(f"\n{'='*80}")
    print("10-LAYER DETECTION TEST COMPLETE")
    print(f"{'='*80}\n")

if __name__ == "__main__":
    main()
