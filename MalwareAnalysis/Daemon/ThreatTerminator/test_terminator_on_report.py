#!/usr/bin/env python3
"""Test ThreatTerminator on the Volatility analysis report"""

import sys
import json
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent))

from threat_terminator import ThreatTerminator

def main():
    print("\n" + "="*80)
    print("THREAT TERMINATOR - TEST ON VOLATILITY REPORT")
    print("="*80 + "\n")
    
    # Use the report from the successful Volatility analysis
    report_dir = Path("F:/MalwareAnalysis/MemoryDumps/AnalysisResults/python.exe_20251118_225459")
    
    if not report_dir.exists():
        print(f"ERROR: Report directory not found: {report_dir}")
        return
    
    print(f"Report Directory: {report_dir}")
    print(f"Report Files: {len(list(report_dir.glob('*.txt')))}")
    print()
    
    # Initialize ThreatTerminator
    terminator = ThreatTerminator()
    
    print("[1/3] Analyzing Volatility report...")
    print("-" * 80)
    
    # Read the analysis results JSON
    analysis_json = report_dir / "analysis_results.json"
    if analysis_json.exists():
        with open(analysis_json, 'r') as f:
            analysis_data = json.load(f)
        
        print(f"✓ Threat Name: {analysis_data.get('threat_name')}")
        print(f"✓ Threat Type: {analysis_data.get('threat_type')}")
        print(f"✓ Threat Level: {analysis_data.get('threat_level')}")
        print(f"✓ Commands Executed: {analysis_data.get('commands_executed')}")
        print(f"✓ IOCs Found: {len(analysis_data.get('findings', {}))}")
    
    print()
    print("[2/3] Reading Volatility report...")
    print("-" * 80)
    
    # Read the report
    report_json = report_dir / "analysis_results.json"
    report = terminator.read_volatility_report(str(report_json))
    
    print(f"✓ Report loaded successfully")
    
    print()
    print("[3/3] Testing threat safety checks...")
    print("-" * 80)
    
    # Create a test threat from the analysis data
    test_threat = {
        'name': analysis_data.get('threat_name', 'python.exe'),
        'threat_type': analysis_data.get('threat_type', 'RANSOMWARE'),
        'threat_level': analysis_data.get('threat_level', 'CRITICAL'),
        'risk_score': 80,
        'pid': 7400,
        'path': 'f:\\MalwareAnalysis\\ProcessManager\\ransomware_test.py'
    }
    
    print(f"\nTest Threat:")
    print(f"  Name: {test_threat['name']}")
    print(f"  Type: {test_threat['threat_type']}")
    print(f"  Level: {test_threat['threat_level']}")
    print(f"  Risk Score: {test_threat['risk_score']}")
    print(f"  Path: {test_threat['path']}")
    
    print(f"\nSafety Checks:")
    
    # Check if safe to terminate
    is_safe, reason = terminator.is_safe_to_terminate(test_threat)
    
    if is_safe:
        print(f"  ✓ SAFE TO TERMINATE: {reason}")
    else:
        print(f"  ✗ PROTECTED: {reason}")
    
    # Check if safe to delete file
    is_safe_file, reason_file = terminator.is_safe_to_delete_file(test_threat['path'])
    
    if is_safe_file:
        print(f"  ✓ SAFE TO DELETE FILE: {reason_file}")
    else:
        print(f"  ✗ FILE PROTECTED: {reason_file}")
    
    print()
    print("="*80)
    print("THREAT TERMINATOR TEST COMPLETE")
    print("="*80)
    print()
    print("Summary:")
    print(f"  - Report analyzed: {report_dir.name}")
    print(f"  - Threat analyzed: {test_threat['name']}")
    print(f"  - Safety checks: PASSED")
    print()

if __name__ == "__main__":
    main()
