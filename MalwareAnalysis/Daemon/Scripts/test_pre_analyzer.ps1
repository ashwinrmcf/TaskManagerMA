# ============================================================================
# Pre-Analyzer Testing Script
# Tests the PreAnalyzer module from PowerShell with comprehensive reporting
# ============================================================================

param(
    [string]$Action = "full",
    [switch]$Verbose = $false,
    [switch]$ShowResults = $true,
    [switch]$ExportJSON = $false
)

# Configuration
$DaemonRoot = "f:\MalwareAnalysis\Daemon"
$PreAnalyzerPath = "$DaemonRoot\PreAnalyzer"
$ConfigPath = "$DaemonRoot\Config"
$LogPath = "$DaemonRoot\Logs\pre_analysis"
$ReportPath = "$DaemonRoot\Reports"

# Create necessary directories
@($LogPath, $ReportPath) | ForEach-Object {
    if (-not (Test-Path $_)) {
        New-Item -ItemType Directory -Path $_ -Force | Out-Null
    }
}

# ============================================================================
# Helper Functions
# ============================================================================

function Write-Header {
    param([string]$Text)
    Write-Host "`n" + ("=" * 80) -ForegroundColor Cyan
    Write-Host "  $Text" -ForegroundColor Cyan
    Write-Host ("=" * 80) -ForegroundColor Cyan
}

function Write-Section {
    param([string]$Text)
    Write-Host "`n>>> $Text" -ForegroundColor Green
}

function Write-Info {
    param([string]$Text)
    Write-Host "    [INFO] $Text" -ForegroundColor White
}

function Write-Success {
    param([string]$Text)
    Write-Host "    [✓] $Text" -ForegroundColor Green
}

function Write-Warning {
    param([string]$Text)
    Write-Host "    [!] $Text" -ForegroundColor Yellow
}

function Write-Error {
    param([string]$Text)
    Write-Host "    [✗] $Text" -ForegroundColor Red
}

# ============================================================================
# Pre-Flight Checks
# ============================================================================

function Test-Prerequisites {
    Write-Header "Pre-Flight Checks"
    
    $allGood = $true
    
    # Check Python
    Write-Section "Checking Python Installation"
    try {
        $pythonVersion = python --version 2>&1
        Write-Success "Python found: $pythonVersion"
    } catch {
        Write-Error "Python not found in PATH"
        $allGood = $false
    }
    
    # Check PreAnalyzer module
    Write-Section "Checking PreAnalyzer Module"
    if (Test-Path $PreAnalyzerPath) {
        Write-Success "PreAnalyzer path exists: $PreAnalyzerPath"
        
        $requiredFiles = @(
            "__init__.py",
            "pre_analyzer.py",
            "process_scanner.py",
            "file_scanner.py",
            "behavior_detector.py",
            "quarantine_manager.py"
        )
        
        foreach ($file in $requiredFiles) {
            $filePath = Join-Path $PreAnalyzerPath $file
            if (Test-Path $filePath) {
                Write-Success "Found: $file"
            } else {
                Write-Error "Missing: $file"
                $allGood = $false
            }
        }
    } else {
        Write-Error "PreAnalyzer path not found: $PreAnalyzerPath"
        $allGood = $false
    }
    
    # Check Config directory
    Write-Section "Checking Configuration"
    if (Test-Path $ConfigPath) {
        Write-Success "Config directory exists: $ConfigPath"
        
        $configFiles = Get-ChildItem $ConfigPath -Filter "*.txt", "*.json" -ErrorAction SilentlyContinue
        Write-Info "Found $($configFiles.Count) configuration files"
    } else {
        Write-Warning "Config directory not found: $ConfigPath"
    }
    
    # Check essential_processes.txt
    Write-Section "Checking Whitelist"
    $whitelistPath = "$ConfigPath\essential_processes.txt"
    if (Test-Path $whitelistPath) {
        $whitelistCount = @(Get-Content $whitelistPath | Where-Object { $_ -and -not $_.StartsWith("#") }).Count
        Write-Success "Whitelist found with $whitelistCount entries"
    } else {
        Write-Warning "Whitelist not found: $whitelistPath"
    }
    
    return $allGood
}

# ============================================================================
# Test Execution
# ============================================================================

function Run-PreAnalyzerTest {
    param([string]$TestType = "full")
    
    Write-Header "Running PreAnalyzer Test: $TestType"
    
    $timestamp = Get-Date -Format "yyyyMMdd_HHmmss"
    $reportFile = "$ReportPath\pre_analyzer_test_$timestamp.json"
    $logFile = "$LogPath\test_$timestamp.log"
    
    # Create Python test script
    $pythonScript = @"
import sys
import json
from pathlib import Path
from datetime import datetime

# Add daemon to path
sys.path.insert(0, r'$DaemonRoot')

try:
    from PreAnalyzer import PreAnalyzer
    
    # Initialize
    config_dir = Path(r'$ConfigPath')
    log_dir = Path(r'$LogPath')
    
    pre_analyzer = PreAnalyzer(config_dir, log_dir)
    
    # Run analysis
    print("[*] Starting Pre-Analysis...")
    results = pre_analyzer.analyze()
    
    # Prepare report
    report = {
        'timestamp': datetime.now().isoformat(),
        'test_type': '$TestType',
        'results': {
            'suspicious_processes': len(results.get('suspicious_processes', [])),
            'clean_processes': results.get('clean_processes', 0),
            'analysis_time': results.get('analysis_time', 0),
            'total_scanned': results.get('total_scanned', 0)
        },
        'statistics': {
            'total_scans': pre_analyzer.total_scans,
            'threats_found': pre_analyzer.threats_found,
            'false_positives': pre_analyzer.false_positives
        },
        'quarantine': {
            'total_quarantined': pre_analyzer.quarantine_manager.get_quarantine_stats().get('total_quarantined', 0),
            'quarantine_size_mb': pre_analyzer.quarantine_manager.get_quarantine_stats().get('total_size_mb', 0)
        },
        'detailed_results': results
    }
    
    # Output JSON
    print(json.dumps(report, indent=2, default=str))
    
except Exception as e:
    error_report = {
        'error': True,
        'message': str(e),
        'type': type(e).__name__,
        'timestamp': datetime.now().isoformat()
    }
    print(json.dumps(error_report, indent=2))
    sys.exit(1)
"@
    
    # Save and run Python script
    $pythonScriptPath = "$env:TEMP\pre_analyzer_test_$timestamp.py"
    $pythonScript | Out-File -FilePath $pythonScriptPath -Encoding UTF8
    
    Write-Section "Executing PreAnalyzer"
    Write-Info "Python script: $pythonScriptPath"
    Write-Info "Report file: $reportFile"
    
    try {
        $output = python $pythonScriptPath 2>&1
        
        # Parse JSON output
        $jsonOutput = $output -join "`n"
        $report = $jsonOutput | ConvertFrom-Json
        
        # Save report
        $report | ConvertTo-Json -Depth 10 | Out-File -FilePath $reportFile -Encoding UTF8
        Write-Success "Report saved: $reportFile"
        
        return $report
    } catch {
        Write-Error "Failed to execute PreAnalyzer: $_"
        return $null
    } finally {
        # Cleanup
        if (Test-Path $pythonScriptPath) {
            Remove-Item $pythonScriptPath -Force -ErrorAction SilentlyContinue
        }
    }
}

# ============================================================================
# Results Display
# ============================================================================

function Show-Results {
    param([PSCustomObject]$Report)
    
    if ($null -eq $Report) {
        Write-Error "No report to display"
        return
    }
    
    Write-Header "Analysis Results"
    
    if ($Report.error) {
        Write-Error "Analysis failed: $($Report.message)"
        Write-Error "Error type: $($Report.type)"
        return
    }
    
    # Summary
    Write-Section "Summary"
    Write-Info "Timestamp: $($Report.timestamp)"
    Write-Info "Test Type: $($Report.test_type)"
    
    # Results
    Write-Section "Detection Results"
    Write-Info "Total Processes Scanned: $($Report.results.total_scanned)"
    Write-Info "Clean Processes: $($Report.results.clean_processes)"
    
    if ($Report.results.suspicious_processes -gt 0) {
        Write-Warning "Suspicious Processes Found: $($Report.results.suspicious_processes)"
    } else {
        Write-Success "No Suspicious Processes Found"
    }
    
    Write-Info "Analysis Time: $($Report.results.analysis_time) seconds"
    
    # Statistics
    Write-Section "Statistics"
    Write-Info "Total Scans Performed: $($Report.statistics.total_scans)"
    Write-Info "Total Threats Found: $($Report.statistics.threats_found)"
    Write-Info "False Positives: $($Report.statistics.false_positives)"
    
    # Quarantine
    Write-Section "Quarantine Status"
    Write-Info "Total Quarantined Files: $($Report.quarantine.total_quarantined)"
    Write-Info "Quarantine Size: $($Report.quarantine.quarantine_size_mb) MB"
    
    # Detailed results if available
    if ($Report.detailed_results.suspicious_processes) {
        Write-Section "Suspicious Processes Details"
        $Report.detailed_results.suspicious_processes | ForEach-Object {
            Write-Warning "PID: $($_.pid) | Name: $($_.name) | Risk: $($_.risk_level) | Score: $($_.risk_score)"
        }
    }
}

# ============================================================================
# Main Execution
# ============================================================================

function Main {
    Write-Host "`n" -ForegroundColor Cyan
    Write-Host "╔════════════════════════════════════════════════════════════════════════════════╗" -ForegroundColor Cyan
    Write-Host "║                    PRE-ANALYZER TESTING SCRIPT                                 ║" -ForegroundColor Cyan
    Write-Host "║                  Daemon Threat Detection Module Tester                         ║" -ForegroundColor Cyan
    Write-Host "╚════════════════════════════════════════════════════════════════════════════════╝" -ForegroundColor Cyan
    
    # Pre-flight checks
    $prereqsOK = Test-Prerequisites
    
    if (-not $prereqsOK) {
        Write-Error "Prerequisites check failed. Please fix issues above."
        exit 1
    }
    
    Write-Success "All prerequisites met!"
    
    # Run test
    $report = Run-PreAnalyzerTest -TestType $Action
    
    # Show results
    if ($ShowResults -and $null -ne $report) {
        Show-Results $report
    }
    
    # Export JSON if requested
    if ($ExportJSON -and $null -ne $report) {
        Write-Section "JSON Export"
        $jsonPath = "$ReportPath\latest_report.json"
        $report | ConvertTo-Json -Depth 10 | Out-File -FilePath $jsonPath -Encoding UTF8
        Write-Success "JSON exported: $jsonPath"
    }
    
    Write-Header "Test Complete"
    Write-Success "PreAnalyzer test completed successfully"
    Write-Info "Report location: $ReportPath"
    Write-Info "Log location: $LogPath"
}

# Run main
Main
