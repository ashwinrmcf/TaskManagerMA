"""
Complete Memory Analysis Pipeline
Volatility + Enhanced Analysis = Complete Malicious Activity Tracing
"""

import sys
from pathlib import Path
from datetime import datetime

# Add parent directory to path
sys.path.insert(0, str(Path(__file__).parent))

from volatility_analyzer import VolatilityAnalyzer
from enhanced_memory_analysis import EnhancedMemoryAnalyzer


def print_header(title):
    """Print formatted header"""
    print(f"\n{'='*80}")
    print(f"{title:^80}")
    print(f"{'='*80}\n")


def run_complete_analysis(dump_file, threat_type="RANSOMWARE", threat_level="CRITICAL", threat_name="unknown"):
    """Run complete memory analysis pipeline"""
    
    print_header("COMPLETE MEMORY ANALYSIS PIPELINE")
    print(f"Dump File: {dump_file}")
    print(f"Threat Type: {threat_type}")
    print(f"Threat Level: {threat_level}")
    print(f"Threat Name: {threat_name}\n")
    
    # Step 1: Volatility Analysis
    print_header("STEP 1: VOLATILITY FORENSIC ANALYSIS")
    print("Executing 44 volatility commands for comprehensive memory forensics...")
    
    try:
        analyzer = VolatilityAnalyzer()
        volatility_results = analyzer.analyze_dump(
            dump_file=dump_file,
            threat_type=threat_type,
            threat_level=threat_level,
            threat_name=threat_name,
            profile=None
        )
        
        print(f"\n✓ Volatility Analysis Complete")
        print(f"  Commands Executed: {volatility_results['commands_executed']}")
        print(f"  Commands Failed: {volatility_results['commands_failed']}")
        print(f"  Success Rate: {(volatility_results['commands_executed'] / max(1, volatility_results['commands_executed'] + volatility_results['commands_failed'])) * 100:.1f}%")
        print(f"  IOCs Found: {len(volatility_results['iocs'])}")
        print(f"  Analysis Directory: {volatility_results['analysis_dir']}")
        
    except Exception as e:
        print(f"✗ Volatility Analysis Failed: {e}")
        return None
    
    # Step 2: Enhanced Memory Analysis
    print_header("STEP 2: ENHANCED MALICIOUS ACTIVITY TRACING")
    print("Analyzing volatility outputs for complete threat chain...")
    
    try:
        enhanced_analyzer = EnhancedMemoryAnalyzer(volatility_results['analysis_dir'])
        enhanced_results = enhanced_analyzer.analyze_all()
        
        print(f"\n✓ Enhanced Analysis Complete")
        print(f"  Overall Threat Score: {enhanced_results['overall_threat_score']}/100")
        print(f"  Behavioral Patterns: {len(enhanced_results['behavioral_patterns'])}")
        print(f"  Persistence Mechanisms: {len(enhanced_results['persistence_mechanisms'])}")
        print(f"  Privilege Escalation: {len(enhanced_results['privilege_escalation'])}")
        print(f"  Code Injection: {len(enhanced_results['injection_chains'])}")
        print(f"  C2 Communication: {len(enhanced_results['c2_communication'])}")
        print(f"  Evasion Techniques: {len(enhanced_results['evasion_techniques'])}")
        
        # Save reports
        enhanced_analyzer.save_report()
        text_report = enhanced_analyzer.generate_text_report()
        
        with open(Path(volatility_results['analysis_dir']) / 'ENHANCED_ANALYSIS.txt', 'w') as f:
            f.write(text_report)
        
        print(f"\n  Reports saved to: {volatility_results['analysis_dir']}")
        
    except Exception as e:
        print(f"✗ Enhanced Analysis Failed: {e}")
        import traceback
        traceback.print_exc()
        return None
    
    # Step 3: Combined Report
    print_header("STEP 3: COMBINED THREAT ASSESSMENT")
    
    # Display threat chain
    print("THREAT CHAIN (MITRE ATT&CK Framework):")
    for stage in enhanced_results['threat_chain']:
        print(f"  [{stage['severity']}] {stage['stage']}: {stage['indicators']} indicators")
    
    # Display top threats
    print("\nTOP THREATS DETECTED:")
    
    all_threats = []
    for pattern in enhanced_results['behavioral_patterns']:
        all_threats.append((pattern['severity'], pattern['type'], pattern.get('description', '')))
    for mech in enhanced_results['persistence_mechanisms']:
        all_threats.append((mech['severity'], mech['type'], mech.get('description', '')))
    for esc in enhanced_results['privilege_escalation']:
        all_threats.append((esc['severity'], esc['type'], esc.get('description', '')))
    for inj in enhanced_results['injection_chains']:
        all_threats.append((inj['severity'], inj['type'], inj.get('description', '')))
    for c2 in enhanced_results['c2_communication']:
        all_threats.append((c2['severity'], c2['type'], c2.get('description', '')))
    
    # Sort by severity
    severity_order = {'CRITICAL': 0, 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3}
    all_threats.sort(key=lambda x: severity_order.get(x[0], 4))
    
    for i, (severity, threat_type, description) in enumerate(all_threats[:15], 1):
        print(f"  {i}. [{severity}] {threat_type}: {description}")
    
    if len(all_threats) > 15:
        print(f"  ... and {len(all_threats) - 15} more threats")
    
    # Display recommendations
    print("\nRECOMMENDED ACTIONS:")
    for i, rec in enumerate(enhanced_results['recommendations'], 1):
        print(f"  {i}. {rec}")
    
    # Final summary
    print_header("ANALYSIS SUMMARY")
    print(f"Threat Score: {enhanced_results['overall_threat_score']}/100")
    
    if enhanced_results['overall_threat_score'] >= 80:
        print("Status: ⚠️  CRITICAL - Immediate action required")
    elif enhanced_results['overall_threat_score'] >= 60:
        print("Status: ⚠️  HIGH - Urgent investigation needed")
    elif enhanced_results['overall_threat_score'] >= 40:
        print("Status: ⚠️  MEDIUM - Investigation recommended")
    else:
        print("Status: ✓ LOW - Monitor for changes")
    
    print(f"\nAnalysis Complete: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print(f"Results saved to: {volatility_results['analysis_dir']}")
    
    return {
        'volatility_results': volatility_results,
        'enhanced_results': enhanced_results
    }


if __name__ == "__main__":
    from volatility_analyzer import VolatilityAnalyzer
    
    # Find latest dump
    dumps_dir = Path("F:/MalwareAnalysis/MemoryDumps")
    dumps = list(dumps_dir.rglob("*.raw"))
    
    if not dumps:
        print("[ERROR] No memory dumps found!")
        sys.exit(1)
    
    # Analyze latest dump
    latest_dump = sorted(dumps, key=lambda x: x.stat().st_mtime, reverse=True)[0]
    
    print(f"Analyzing latest dump: {latest_dump.name}")
    
    results = run_complete_analysis(
        dump_file=str(latest_dump),
        threat_type="RANSOMWARE",
        threat_level="CRITICAL",
        threat_name=latest_dump.stem
    )
    
    if results:
        print("\n✓ Complete memory analysis successful!")
    else:
        print("\n✗ Complete memory analysis failed!")
        sys.exit(1)
