#!/usr/bin/env python3
"""
Windows Service and Task Whitelist - Protect legitimate Windows components
This module defines whitelists for legitimate Windows services and scheduled tasks
that should never be deleted during malware cleanup operations.
"""

# Critical Windows services that should NEVER be deleted
PROTECTED_WINDOWS_SERVICES = {
    # Windows Defender
    'WinDefend': 'Windows Defender Antivirus Service',
    'WdNisSvc': 'Windows Defender Network Inspection Service',
    'SecurityHealthService': 'Windows Security Health Service',
    'Sense': 'Windows Defender Advanced Threat Protection Service',
    
    # System Core Services
    'TrustedInstaller': 'Windows Modules Installer',
    'wuauserv': 'Windows Update',
    'BITS': 'Background Intelligent Transfer Service',
    'CryptSvc': 'Cryptographic Services',
    'EventLog': 'Windows Event Log',
    'PlugPlay': 'Plug and Play',
    'RpcSs': 'Remote Procedure Call (RPC)',
    'Themes': 'Themes',
    'AudioSrv': 'Windows Audio',
    'AudioEndpointBuilder': 'Windows Audio Endpoint Builder',
    'Dhcp': 'DHCP Client',
    'Dnscache': 'DNS Client',
    'LanmanServer': 'Server',
    'LanmanWorkstation': 'Workstation',
    'Netlogon': 'Netlogon',
    'NlaSvc': 'Network Location Awareness',
    'nsi': 'Network Store Interface Service',
    'PolicyAgent': 'IPsec Policy Agent',
    'ProfSvc': 'User Profile Service',
    'Schedule': 'Task Scheduler',
    'SENS': 'System Event Notification Service',
    'ShellHWDetection': 'Shell Hardware Detection',
    'Spooler': 'Print Spooler',
    'SysMain': 'SysMain',
    'UxSms': 'Desktop Window Manager Session Manager',
    'Winmgmt': 'Windows Management Instrumentation',
    'WSearch': 'Windows Search',
    
    # Microsoft Core Services
    'MDCoreSvc': 'Microsoft Defender Core Service',
    'MpsSvc': 'Windows Firewall',
    'BFE': 'Base Filtering Engine',
    'mpssvc': 'Windows Defender Firewall',
    
    # Hardware and Driver Services
    'PnkBstrA': 'PunkBuster Service A (Gaming)',
    'PnkBstrB': 'PunkBuster Service B (Gaming)',
}

# Critical Windows scheduled tasks that should NEVER be deleted
PROTECTED_SCHEDULED_TASKS = {
    # Windows Update Orchestrator
    r'\Microsoft\Windows\UpdateOrchestrator\StartOobeAppsScanAfterUpdate',
    r'\Microsoft\Windows\UpdateOrchestrator\UpdateModelTask',
    r'\Microsoft\Windows\UpdateOrchestrator\Reboot',
    r'\Microsoft\Windows\UpdateOrchestrator\Schedule Scan',
    r'\Microsoft\Windows\UpdateOrchestrator\Schedule Scan Static Task',
    r'\Microsoft\Windows\UpdateOrchestrator\USO_UxBroker',
    
    # Windows Defender
    r'\Microsoft\Windows\Windows Defender\Windows Defender Cache Maintenance',
    r'\Microsoft\Windows\Windows Defender\Windows Defender Cleanup',
    r'\Microsoft\Windows\Windows Defender\Windows Defender Scheduled Scan',
    r'\Microsoft\Windows\Windows Defender\Windows Defender Verification',
    
    # System Maintenance
    r'\Microsoft\Windows\Maintenance\WinSAT',
    r'\Microsoft\Windows\Registry\RegIdleBackup',
    r'\Microsoft\Windows\Defrag\ScheduledDefrag',
    r'\Microsoft\Windows\DiskDiagnostic\Microsoft-Windows-DiskDiagnosticDataCollector',
    r'\Microsoft\Windows\SystemRestore\SR',
    
    # Windows Security
    r'\Microsoft\Windows\Windows Error Reporting\QueueReporting',
    r'\Microsoft\Windows\Application Experience\Microsoft Compatibility Appraiser',
    r'\Microsoft\Windows\Customer Experience Improvement Program\Consolidator',
    
    # Power Management
    r'\Microsoft\Windows\Power Efficiency Diagnostics\AnalyzeSystem',
    
    # Windows Store and Apps
    r'\Microsoft\Windows\WindowsUpdate\Automatic App Update',
    r'\Microsoft\Windows\License Manager\TempSignedLicenseExchange',
}

def is_protected_service(service_name):
    """Check if a service is protected and should not be deleted"""
    return service_name in PROTECTED_WINDOWS_SERVICES

def is_protected_task(task_path):
    """Check if a scheduled task is protected and should not be deleted"""
    return task_path in PROTECTED_SCHEDULED_TASKS

def get_service_description(service_name):
    """Get description of a protected service"""
    return PROTECTED_WINDOWS_SERVICES.get(service_name, "Unknown Windows Service")

def filter_suspicious_services(services_list):
    """Filter out protected services from a list of suspicious services"""
    return [svc for svc in services_list if not is_protected_service(svc)]

def filter_suspicious_tasks(tasks_list):
    """Filter out protected tasks from a list of suspicious tasks"""
    return [task for task in tasks_list if not is_protected_task(task)]

def log_protected_item_attempt(item_type, item_name):
    """Log when a protected item was attempted to be deleted"""
    if item_type == "service":
        description = get_service_description(item_name)
        return f"üõ°Ô∏è Protected Windows service: {item_name} ({description})"
    elif item_type == "task":
        return f"üõ°Ô∏è Protected Windows task: {item_name}"
    else:
        return f"üõ°Ô∏è Protected Windows component: {item_name}"

if __name__ == "__main__":
    print("Windows Service and Task Whitelist loaded")
    print(f"Protected services: {len(PROTECTED_WINDOWS_SERVICES)}")
    print(f"Protected tasks: {len(PROTECTED_SCHEDULED_TASKS)}")
