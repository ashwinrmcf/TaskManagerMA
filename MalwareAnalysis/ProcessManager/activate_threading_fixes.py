"""
Activation Script for Threading Fixes
Run this script to immediately apply threading fixes to prevent GUI freezing
"""

import sys
import os
from pathlib import Path

def activate_threading_fixes():
    """Activate threading fixes for the Process Manager GUI"""
    
    print("=" * 60)
    print("üöÄ ACTIVATING THREADING FIXES FOR GUI")
    print("=" * 60)
    
    try:
        # Add current directory to path
        current_dir = Path(__file__).parent
        if str(current_dir) not in sys.path:
            sys.path.insert(0, str(current_dir))
        
        print("üìÅ Current directory added to Python path")
        
        # Import the integration module
        try:
            from gui_integration import initialize_threading_system
            print("‚úÖ Threading integration module imported successfully")
        except ImportError as e:
            print(f"‚ùå Failed to import gui_integration: {e}")
            return False
        
        # Initialize the threading system
        print("\nüîß Initializing threading system...")
        success = initialize_threading_system()
        
        if success:
            print("\n" + "=" * 60)
            print("‚úÖ THREADING FIXES ACTIVATED SUCCESSFULLY!")
            print("=" * 60)
            print("\nüéØ Benefits Applied:")
            print("‚Ä¢ Memory dumps now run in background threads")
            print("‚Ä¢ Daemon stop operations are non-blocking")
            print("‚Ä¢ GUI remains responsive during all operations")
            print("‚Ä¢ Emergency GUI recovery system active")
            print("‚Ä¢ All console output captured in GUI")
            print("\nüìã Usage:")
            print("‚Ä¢ Launch your daemon normally")
            print("‚Ä¢ GUI will no longer freeze during operations")
            print("‚Ä¢ All progress shown in Console Output section")
            print("‚Ä¢ Stop daemon button will work without freezing")
            
            return True
        else:
            print("\n‚ùå THREADING SYSTEM INITIALIZATION FAILED")
            return False
            
    except Exception as e:
        print(f"\n‚ùå CRITICAL ERROR: {str(e)}")
        print("\nTroubleshooting:")
        print("1. Ensure all files are in the same directory")
        print("2. Check that PyQt5 is installed")
        print("3. Run as administrator if needed")
        return False

def check_dependencies():
    """Check if all required dependencies are available"""
    
    print("üîç Checking dependencies...")
    
    dependencies = [
        ('PyQt5', 'PyQt5.QtCore'),
        ('psutil', 'psutil'),
        ('pathlib', 'pathlib'),
        ('threading', 'threading'),
        ('subprocess', 'subprocess')
    ]
    
    missing = []
    
    for name, module in dependencies:
        try:
            __import__(module)
            print(f"‚úÖ {name} - Available")
        except ImportError:
            print(f"‚ùå {name} - Missing")
            missing.append(name)
    
    if missing:
        print(f"\n‚ö†Ô∏è Missing dependencies: {', '.join(missing)}")
        print("Install missing packages with:")
        for dep in missing:
            if dep == 'PyQt5':
                print(f"  pip install {dep}")
            elif dep == 'psutil':
                print(f"  pip install {dep}")
        return False
    
    print("‚úÖ All dependencies available")
    return True

def verify_files():
    """Verify that all required files exist"""
    
    print("üìÅ Verifying required files...")
    
    required_files = [
        'threading_fixes.py',
        'gui_integration.py',
        'process_manager_gui.py'
    ]
    
    current_dir = Path(__file__).parent
    missing_files = []
    
    for file in required_files:
        file_path = current_dir / file
        if file_path.exists():
            print(f"‚úÖ {file} - Found")
        else:
            print(f"‚ùå {file} - Missing")
            missing_files.append(file)
    
    if missing_files:
        print(f"\n‚ö†Ô∏è Missing files: {', '.join(missing_files)}")
        print("Ensure all files are in the same directory as this script")
        return False
    
    print("‚úÖ All required files found")
    return True

def show_usage_instructions():
    """Show instructions for using the threading fixes"""
    
    print("\n" + "=" * 60)
    print("üìñ USAGE INSTRUCTIONS")
    print("=" * 60)
    
    print("""
üöÄ HOW TO USE THE THREADING FIXES:

1. AUTOMATIC ACTIVATION:
   ‚Ä¢ Threading fixes activate automatically when you import gui_integration
   ‚Ä¢ No code changes needed in your main GUI file

2. MANUAL ACTIVATION:
   ‚Ä¢ Run this script: python activate_threading_fixes.py
   ‚Ä¢ Or import in your main GUI: from gui_integration import initialize_threading_system

3. WHAT'S FIXED:
   ‚Ä¢ Memory dump operations run in background threads
   ‚Ä¢ GUI stays responsive during dumps (no more freezing!)
   ‚Ä¢ Daemon stop operations are non-blocking
   ‚Ä¢ Console output appears in real-time in GUI
   ‚Ä¢ Emergency recovery system prevents total freezing

4. TESTING:
   ‚Ä¢ Launch your daemon normally
   ‚Ä¢ Click "Start Security Daemon" - GUI won't freeze
   ‚Ä¢ Memory dumps will show progress in Console Output
   ‚Ä¢ Click "Stop Daemon" - no more task manager needed!

5. TROUBLESHOOTING:
   ‚Ä¢ If GUI still freezes, run this script again
   ‚Ä¢ Check Console Output section for threading messages
   ‚Ä¢ Look for "[THREADING-FIX]" messages in output
   
6. VERIFICATION:
   ‚Ä¢ Look for these messages in Console Output:
     - "üîó Global console capture activated"
     - "[THREADING-FIX] ‚úÖ Threading fixes applied successfully"
     - "üöÄ Starting threaded memory dump..."
""")

def main():
    """Main activation function"""
    
    print("üîß Process Manager GUI - Threading Fix Activator")
    print("This script will prevent GUI freezing during memory dumps and daemon operations\n")
    
    # Check dependencies
    if not check_dependencies():
        print("\n‚ùå Dependency check failed. Please install missing packages.")
        return False
    
    # Verify files
    if not verify_files():
        print("\n‚ùå File verification failed. Please ensure all files are present.")
        return False
    
    # Activate threading fixes
    success = activate_threading_fixes()
    
    if success:
        show_usage_instructions()
        
        print("\nüéâ READY TO USE!")
        print("Your GUI will no longer freeze during memory dumps or daemon operations.")
        print("Launch your daemon and enjoy the responsive interface!")
        
    else:
        print("\n‚ùå ACTIVATION FAILED")
        print("Please check the error messages above and try again.")
    
    return success

if __name__ == "__main__":
    try:
        success = main()
        
        # Keep window open to show results
        if not success:
            input("\nPress Enter to exit...")
        else:
            print("\n‚úÖ Activation complete. You can close this window.")
            
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è Activation cancelled by user")
    except Exception as e:
        print(f"\n‚ùå Unexpected error: {str(e)}")
        input("\nPress Enter to exit...")
