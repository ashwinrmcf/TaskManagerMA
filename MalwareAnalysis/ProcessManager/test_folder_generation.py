#!/usr/bin/env python3

from rapid_volatility_test import RapidVolatilityAnalyzer
from pathlib import Path
from datetime import datetime

def test_folder_generation():
    print("Testing process-specific folder generation...")
    
    # Find the most recent dump file automatically
    dump_dir = Path('F:/MalwareAnalysis/MemDump')
    dump_files = list(dump_dir.rglob('*.raw'))
    if dump_files:
        dump_file = max(dump_files, key=lambda f: f.stat().st_mtime)
        print(f"Using most recent dump: {dump_file.name}")
    else:
        dump_file = Path('F:/MalwareAnalysis/MemDump/DumpSession_20250726_231622/FullDiskDump/FullSystemDump_20250726_231622.raw')
    print(f"Dump file exists: {dump_file.exists()}")
    
    if not dump_file.exists():
        print("‚ùå Dump file not found!")
        return
    
    # Initialize analyzer
    analyzer = RapidVolatilityAnalyzer(dump_file, mode='simulated', fast_mode=True)
    print("‚úÖ Analyzer initialized")
    
    # Create test session directory
    session_dir = Path('F:/MalwareAnalysis/VolatilityAnalysis/Test_Session')
    session_dir.mkdir(parents=True, exist_ok=True)
    print(f"‚úÖ Session directory created: {session_dir}")
    
    # Get detailed threats
    threats = analyzer.get_detailed_threats()
    print(f"‚úÖ Found {len(threats)} threats:")
    for threat in threats:
        print(f"   - {threat.get('process', 'unknown')} ({threat.get('classification', 'UNKNOWN')})")
    
    # Generate process-specific reports
    print("\nüìÅ Generating process-specific reports...")
    folders = analyzer.generate_process_specific_reports(threats, session_dir)
    print(f"‚úÖ Created {len(folders)} folders")
    
    # Check what was created
    for folder_info in folders:
        folder_path = folder_info['folder']
        print(f"\nüìÅ {folder_info['process']} ({folder_info['classification']}):")
        print(f"   Path: {folder_path}")
        print(f"   Exists: {folder_path.exists()}")
        if folder_path.exists():
            files = list(folder_path.iterdir())
            print(f"   Files ({len(files)}):")
            for file in files:
                print(f"     - {file.name} ({file.stat().st_size} bytes)")
        else:
            print(f"   ‚ùå Folder was not created!")

if __name__ == "__main__":
    test_folder_generation()
