#!/usr/bin/env python3
"""
Test script to verify the Volatility 3 fix works correctly
"""

import sys
import os
from pathlib import Path

# Add the current directory to Python path
sys.path.insert(0, str(Path(__file__).parent))

# Import the VolatilityWorker from the main GUI file
from process_manager_gui import VolatilityWorker
from PyQt5.QtCore import QCoreApplication

def test_volatility_analysis():
    """Test the enhanced Volatility analysis with the latest memory dump."""
    
    # Create QApplication for Qt signals
    app = QCoreApplication(sys.argv)
    
    # Find the most recent memory dump
    dump_dir = Path(r"F:\MalwareAnalysis\MemDump")
    
    print("ğŸ” Looking for memory dumps...")
    
    # Find all dump files
    dump_files = []
    for session_dir in dump_dir.glob("DumpSession_*"):
        if session_dir.is_dir():
            # Look in FullDiskDump subdirectory
            full_disk_dir = session_dir / "FullDiskDump"
            if full_disk_dir.exists():
                for dump_file in full_disk_dir.glob("*.raw"):
                    dump_files.append(dump_file)
    
    if not dump_files:
        print("âŒ No memory dump files found!")
        return False
    
    # Use the most recent dump file
    latest_dump = max(dump_files, key=lambda f: f.stat().st_mtime)
    print(f"ğŸ“ Using latest dump: {latest_dump}")
    print(f"ğŸ“Š File size: {latest_dump.stat().st_size / (1024**3):.2f} GB")
    
    # Create VolatilityWorker instance
    print("\nğŸš€ Initializing Volatility Worker...")
    worker = VolatilityWorker(latest_dump)
    
    # Connect signals to print output
    def on_output(text):
        print(text, end='')
    
    def on_threat_detected(threat_info):
        print(f"\nğŸš¨ THREAT DETECTED: {threat_info}")
    
    def on_finished():
        print("\nâœ… Volatility analysis completed!")
        app.quit()
    
    worker.output_received.connect(on_output)
    worker.threat_detected.connect(on_threat_detected)
    worker.finished.connect(on_finished)
    
    # Start the analysis
    print("ğŸ”„ Starting enhanced Volatility analysis...")
    worker.start()
    
    # Run the event loop
    return app.exec_()

if __name__ == "__main__":
    print("=" * 60)
    print("ğŸ§ª TESTING ENHANCED VOLATILITY 3 ANALYSIS")
    print("=" * 60)
    
    try:
        result = test_volatility_analysis()
        print(f"\nğŸ¯ Test completed with result: {result}")
    except Exception as e:
        print(f"\nâŒ Test failed with error: {e}")
        import traceback
        traceback.print_exc()
