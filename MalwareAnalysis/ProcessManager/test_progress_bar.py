#!/usr/bin/env python3
"""
Standalone Test for Memory Dump Progress Bar
Tests progress bar functionality in isolation before GUI integration
"""

import sys
import re
from PyQt5.QtWidgets import (QApplication, QDialog, QVBoxLayout, QHBoxLayout, 
                           QLabel, QPushButton, QProgressBar, QFrame, QTextEdit)
from PyQt5.QtCore import QTimer, Qt
from PyQt5.QtGui import QFont

class ProgressBarTester(QDialog):
    """Standalone test dialog for memory dump progress bar"""
    
    def __init__(self):
        super().__init__()
        self.init_ui()
        self.setup_test_scenarios()
        
    def init_ui(self):
        """Initialize the test UI"""
        self.setWindowTitle("Memory Dump Progress Bar Tester")
        self.setFixedSize(600, 500)
        self.setStyleSheet("""
            QDialog {
                background-color: #f8f9fa;
                font-family: 'Segoe UI', Arial, sans-serif;
            }
        """)
        
        layout = QVBoxLayout()
        
        # Title
        title = QLabel("ğŸ§ª Memory Dump Progress Bar Test Suite")
        title.setFont(QFont("Segoe UI", 16, QFont.Bold))
        title.setAlignment(Qt.AlignCenter)
        title.setStyleSheet("color: #495057; margin: 10px;")
        layout.addWidget(title)
        
        # Progress Bar Frame (hidden initially)
        self.dump_progress_frame = QFrame()
        self.dump_progress_frame.setStyleSheet("""
            QFrame {
                background-color: #f8f9fa;
                border: 1px solid #dee2e6;
                border-radius: 4px;
                margin-top: 8px;
                padding: 8px;
            }
        """)
        self.dump_progress_frame.setVisible(False)
        
        # Progress bar layout
        progress_layout = QVBoxLayout()
        
        # Progress label
        self.progress_label = QLabel("ğŸ’¾ Memory Dump Progress")
        self.progress_label.setFont(QFont("Segoe UI", 10, QFont.Bold))
        self.progress_label.setStyleSheet("color: #495057; margin-bottom: 4px;")
        progress_layout.addWidget(self.progress_label)
        
        # Progress bar
        self.dump_progress_bar = QProgressBar()
        self.dump_progress_bar.setMinimum(0)
        self.dump_progress_bar.setMaximum(100)
        self.dump_progress_bar.setValue(0)
        self.dump_progress_bar.setTextVisible(True)
        self.dump_progress_bar.setFormat("ğŸ’¾ Ready - 0mb")
        self.dump_progress_bar.setFixedHeight(35)
        self.dump_progress_bar.setStyleSheet("""
            QProgressBar {
                border: 2px solid #dee2e6;
                border-radius: 6px;
                text-align: center;
                font-weight: bold;
                color: white;
                background-color: #e9ecef;
            }
            QProgressBar::chunk {
                background: qlineargradient(x1:0, y1:0, x2:1, y2:0,
                    stop:0 #28a745, stop:0.5 #20c997, stop:1 #17a2b8);
                border-radius: 4px;
                margin: 1px;
            }
            QProgressBar:hover {
                border: 2px solid #20c997;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
        """)
        progress_layout.addWidget(self.dump_progress_bar)
        
        self.dump_progress_frame.setLayout(progress_layout)
        layout.addWidget(self.dump_progress_frame)
        
        # Debug output
        self.debug_output = QTextEdit()
        self.debug_output.setMaximumHeight(200)
        self.debug_output.setStyleSheet("""
            QTextEdit {
                background-color: #212529;
                color: #28a745;
                font-family: 'Consolas', monospace;
                font-size: 10px;
                border: 1px solid #495057;
                border-radius: 4px;
                padding: 8px;
            }
        """)
        layout.addWidget(QLabel("ğŸ” Debug Output:"))
        layout.addWidget(self.debug_output)
        
        # Test buttons
        button_layout = QHBoxLayout()
        
        # Test automatic trigger
        auto_test_btn = QPushButton("ğŸš€ Test Automatic Trigger")
        auto_test_btn.clicked.connect(self.test_automatic_trigger)
        auto_test_btn.setStyleSheet(self.get_button_style("#007bff"))
        button_layout.addWidget(auto_test_btn)
        
        # Test real progress parsing
        parse_test_btn = QPushButton("ğŸ“Š Test Progress Parsing")
        parse_test_btn.clicked.connect(self.test_progress_parsing)
        parse_test_btn.setStyleSheet(self.get_button_style("#28a745"))
        button_layout.addWidget(parse_test_btn)
        
        # Test complete cycle
        cycle_test_btn = QPushButton("ğŸ”„ Test Complete Cycle")
        cycle_test_btn.clicked.connect(self.test_complete_cycle)
        cycle_test_btn.setStyleSheet(self.get_button_style("#17a2b8"))
        button_layout.addWidget(cycle_test_btn)
        
        layout.addLayout(button_layout)
        
        # Close button
        close_btn = QPushButton("âŒ Close")
        close_btn.clicked.connect(self.close)
        close_btn.setStyleSheet(self.get_button_style("#dc3545"))
        layout.addWidget(close_btn)
        
        self.setLayout(layout)
        
    def get_button_style(self, color):
        """Get button style with specified color"""
        return f"""
            QPushButton {{
                background-color: {color};
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 6px;
                font-weight: bold;
                font-size: 11px;
            }}
            QPushButton:hover {{
                background-color: {color}dd;
                transform: translateY(-1px);
            }}
            QPushButton:pressed {{
                transform: translateY(1px);
            }}
        """
        
    def setup_test_scenarios(self):
        """Setup test scenarios"""
        self.test_messages = [
            "[STATUS] ğŸ”„ Countdown: 3 seconds remaining...",
            "[STATUS] ğŸ”„ Countdown: 2 seconds remaining...", 
            "[STATUS] FINAL WARNING : MEMORY DUMP STARTING IN 1 SECOND",
            "[STATUS] ğŸ’¾ Creating dump: 422/8192 MB (5.2%) | Speed: 210.3 MB/s",
            "[STATUS] ğŸ’¾ Creating dump: 1370/8192 MB (16.7%) | Speed: 657.9 MB/s",
            "[STATUS] ğŸ’¾ Creating dump: 2890/8192 MB (35.3%) | Speed: 455.2 MB/s",
            "[STATUS] ğŸ’¾ Creating dump: 4567/8192 MB (55.8%) | Speed: 389.4 MB/s",
            "[STATUS] ğŸ’¾ Creating dump: 6234/8192 MB (76.1%) | Speed: 298.7 MB/s",
            "[STATUS] ğŸ’¾ Creating dump: 7666/8192 MB (93.6%) | Speed: 126.4 MB/s",
            "[STATUS] ğŸ’¾ Creating dump: 8192/8192 MB (100.0%) | Speed: 89.2 MB/s",
            "[STATUS] âœ… Memory dump completed successfully!"
        ]
        
    def log_debug(self, message):
        """Add debug message to output"""
        self.debug_output.append(f"[NOW] {message}")
        print(message)  # Also print to console
        
    def show_dump_progress(self):
        """Show the dump progress bar"""
        self.log_debug("ğŸŸ¢ SHOW: Progress bar made visible")
        self.dump_progress_frame.setVisible(True)
        self.dump_progress_bar.setValue(0)
        self.dump_progress_bar.setFormat("ğŸ’¾ Initializing - 0mb")
        
    def update_dump_progress(self, percentage, size_mb):
        """Update progress bar with percentage and size"""
        self.log_debug(f"ğŸ“Š UPDATE: {percentage}% ({size_mb}mb)")
        
        # Dynamic icons based on progress
        if percentage < 20:
            icon = "ğŸ’¾"  # Floppy disk
        elif percentage < 40:
            icon = "ğŸ’¿"  # CD
        elif percentage < 60:
            icon = "ğŸ“€"  # DVD  
        elif percentage < 80:
            icon = "âš¡"  # Lightning
        elif percentage < 100:
            icon = "ğŸ”¥"  # Fire
        else:
            icon = "âœ…"  # Checkmark
            
        self.dump_progress_bar.setValue(int(percentage))
        self.dump_progress_bar.setFormat(f"{icon} {size_mb}mb ({percentage:.1f}%)")
        
    def complete_dump_progress(self):
        """Complete the dump progress"""
        self.log_debug("âœ… COMPLETE: Dump finished, showing completion")
        self.dump_progress_bar.setValue(100)
        self.dump_progress_bar.setFormat("âœ… Dump Complete - 8192mb")
        
    def hide_dump_progress(self):
        """Hide the dump progress bar"""
        self.log_debug("ğŸ”´ HIDE: Progress bar hidden")
        self.dump_progress_frame.setVisible(False)
        
    def parse_and_update_real_progress(self, status):
        """Parse real-time dump progress status messages"""
        try:
            self.log_debug(f"ğŸ” PARSE: Analyzing status message")
            match = re.search(r'Creating dump: (\d+)/(\d+) MB \((\d+\.\d+)%\)', status)
            if match:
                current_mb = int(match.group(1))
                total_mb = int(match.group(2))
                percentage = float(match.group(3))
                
                self.log_debug(f"âœ… PARSED: {current_mb}/{total_mb}MB ({percentage}%)")
                
                if not self.dump_progress_frame.isVisible():
                    self.show_dump_progress()
                    
                self.update_dump_progress(percentage, current_mb)
                
                if percentage >= 100:
                    QTimer.singleShot(1000, self.complete_dump_progress)
                    QTimer.singleShot(4000, self.hide_dump_progress)
                    
                return True
            else:
                self.log_debug(f"âŒ PARSE FAILED: Could not extract progress from: {status}")
                return False
        except Exception as e:
            self.log_debug(f"ğŸš¨ PARSE ERROR: {e}")
            return False
            
    def update_status_label(self, status):
        """Simulate the main GUI's status label update method"""
        self.log_debug(f"ğŸ“¢ STATUS: {status}")
        
        # Check for trigger conditions
        if "FINAL WARNING" in status or "INITIATING FULL SYSTEM MEMORY DUMP" in status:
            self.log_debug("ğŸ¯ TRIGGER: Final warning detected - showing progress bar")
            self.show_dump_progress()
            
        # Check for progress updates
        if "Creating dump:" in status:
            self.log_debug("ğŸ“Š PROGRESS: Dump progress detected - parsing...")
            self.parse_and_update_real_progress(status)
            
    def test_automatic_trigger(self):
        """Test automatic progress bar trigger"""
        self.log_debug("ğŸ§ª TEST: Starting automatic trigger test")
        self.debug_output.clear()
        
        # Simulate countdown messages
        for i, message in enumerate(self.test_messages[:3]):
            QTimer.singleShot(i * 1000, lambda msg=message: self.update_status_label(msg))
            
    def test_progress_parsing(self):
        """Test real progress message parsing"""
        self.log_debug("ğŸ§ª TEST: Starting progress parsing test")
        self.debug_output.clear()
        
        # Test all progress messages
        for i, message in enumerate(self.test_messages[3:]):
            QTimer.singleShot(i * 1500, lambda msg=message: self.update_status_label(msg))
            
    def test_complete_cycle(self):
        """Test complete dump cycle"""
        self.log_debug("ğŸ§ª TEST: Starting complete cycle test")
        self.debug_output.clear()
        
        # Test all messages in sequence
        for i, message in enumerate(self.test_messages):
            delay = i * 1200  # 1.2 seconds between messages
            QTimer.singleShot(delay, lambda msg=message: self.update_status_label(msg))

def main():
    """Run the progress bar test"""
    app = QApplication(sys.argv)
    
    # Set application style
    app.setStyle('Fusion')
    
    tester = ProgressBarTester()
    tester.show()
    
    print("ğŸ§ª Progress Bar Tester Started")
    print("ğŸ“‹ Available Tests:")
    print("   ğŸš€ Automatic Trigger - Tests FINAL WARNING detection")
    print("   ğŸ“Š Progress Parsing - Tests real progress message parsing")
    print("   ğŸ”„ Complete Cycle - Tests full countdown â†’ dump â†’ complete cycle")
    print("\nğŸ” Watch the debug output for detailed analysis!")
    
    sys.exit(app.exec_())

if __name__ == "__main__":
    main()
