#!/usr/bin/env python3
"""
Smart Aggressive Protection - Maximum malware detection with development tool protection
Maintains 10ms aggressive scanning but with comprehensive whitelisting for legitimate tools
"""

import os
import sys
import time
import psutil
import threading
import subprocess
import ctypes
import winreg
import hashlib
from pathlib import Path
from ctypes import wintypes, windll
from PyQt5.QtCore import QThread, pyqtSignal

class SmartAggressiveProtection(QThread):
    """Smart aggressive protection - fast malware detection with intelligent whitelisting"""
    
    threat_detected = pyqtSignal(str, str, str)  # threat_type, process_name, action
    
    def __init__(self):
        super().__init__()
        self.running = True
        self.scan_interval = 0.01  # 10ms - AGGRESSIVE scanning for malware
        
        # COMPREHENSIVE WHITELIST - Absolutely protected processes
        self.critical_whitelist = {
            # Development Tools (HIGHEST PRIORITY - NEVER TOUCH)
            'windsurf.exe', 'windsurf', 'cascade.exe', 'cascade',
            'code.exe', 'code', 'devenv.exe', 'visual studio',
            'notepad++.exe', 'notepad.exe', 'sublime_text.exe',
            'atom.exe', 'brackets.exe', 'vim.exe', 'emacs.exe',
            
            # Python Ecosystem (CRITICAL - NEVER TOUCH)
            'python.exe', 'pythonw.exe', 'python3.exe', 'python3',
            'pip.exe', 'pip3.exe', 'conda.exe', 'jupyter.exe',
            'ipython.exe', 'spyder.exe', 'pycharm.exe', 'pycharm64.exe',
            
            # Node.js and Web Development
            'node.exe', 'npm.exe', 'yarn.exe', 'webpack.exe',
            'ng.exe', 'react-scripts.exe', 'next.exe',
            
            # System Processes (ESSENTIAL - NEVER TOUCH)
            'system', 'smss.exe', 'csrss.exe', 'wininit.exe', 'winlogon.exe',
            'services.exe', 'lsass.exe', 'svchost.exe', 'spoolsv.exe', 
            'explorer.exe', 'dwm.exe', 'taskhost.exe', 'taskhostw.exe',
            'audiodg.exe', 'conhost.exe', 'windefend.exe', 'msmpeng.exe',
            'antimalware service executable', 'windows security health service',
            
            # Browsers (PROTECTED)
            'chrome.exe', 'firefox.exe', 'msedge.exe', 'iexplore.exe',
            'opera.exe', 'brave.exe', 'vivaldi.exe',
            
            # Communication and Productivity
            'discord.exe', 'teams.exe', 'zoom.exe', 'skype.exe',
            'slack.exe', 'telegram.exe', 'whatsapp.exe',
            'outlook.exe', 'thunderbird.exe', 'word.exe', 'excel.exe',
            
            # System Tools and Utilities
            'cmd.exe', 'powershell.exe', 'powershell_ise.exe',
            'msiexec.exe', 'wuauclt.exe', 'taskmgr.exe', 'regedit.exe',
            'control.exe', 'msconfig.exe', 'services.msc',
            
            # Windows Search and Language Services
            'searchapp.exe', 'searchui.exe', 'searchindexer.exe',
            'language_server_windows_x64.exe', 'languageserver.exe',
            
            # Development and Search Tools
            'rg.exe', 'ripgrep.exe', 'grep.exe', 'find.exe', 'findstr.exe',
            
            # Version Control and Git
            'git.exe', 'git-bash.exe', 'tortoisegit.exe', 'sourcetree.exe',
            'github desktop.exe', 'gitkraken.exe',
            
            # Database and Server Tools
            'mysql.exe', 'mysqld.exe', 'postgres.exe', 'redis-server.exe',
            'mongodb.exe', 'apache.exe', 'nginx.exe', 'iis.exe',
            
            # Virtualization and Containers
            'vmware.exe', 'virtualbox.exe', 'docker.exe', 'dockerd.exe',
            'wsl.exe', 'bash.exe',
            
            # Process Manager (Don't kill ourselves!)
            'process_manager_gui.exe', 'process_manager_gui.py'
        }
        
        # Protected directories - NEVER scan these for threats
        self.protected_paths = {
            Path(sys.executable).parent,  # Python installation
            Path("C:/Windows/System32"),
            Path("C:/Windows/SysWOW64"),
            Path("C:/Program Files"),
            Path("C:/Program Files (x86)"),
            Path.home() / "AppData/Local/Programs",  # User applications
            Path.home() / "AppData/Roaming",
            Path("C:/ProgramData/Microsoft"),
            Path("C:/Users/windows/AppData/Local/Microsoft")
        }
        
        # AGGRESSIVE MALWARE SIGNATURES - These get terminated immediately
        self.malware_signatures = {
            # Ransomware families
            'satan', 'wannacry', 'wannacrypt', 'wcry', 'wncry', 'locky', 'cerber',
            'petya', 'notpetya', 'badrabbit', 'ryuk', 'maze', 'revil', 'sodinokibi',
            'gandcrab', 'dharma', 'phobos', 'stop', 'djvu', 'conti', 'lockbit',
            'blackmatter', 'darkside', 'ragnar', 'egregor', 'netwalker', 'avaddon',
            'babuk', 'clop', 'cuba', 'hive', 'prometheus', 'ragnarok', 'thanos',
            
            # Generic malware terms
            'ransomware', 'encrypt', 'decrypt', 'ransom', 'bitcoin', 'crypto',
            'locker', 'crypt', 'cipher', 'locked', 'encoded', 'scrambled',
            
            # Trojans and backdoors
            'trojan', 'backdoor', 'keylogger', 'spyware', 'rootkit', 'botnet',
            'rat', 'remote', 'shell', 'reverse', 'bind', 'nc', 'netcat',
            
            # Miners
            'miner', 'cryptominer', 'coinminer', 'xmrig', 'cpuminer', 'minerd',
            'cgminer', 'bfgminer', 'sgminer', 'claymore', 'phoenixminer',
            
            # Credential stealers
            'mimikatz', 'kiwi', 'sekurlsa', 'lsadump', 'procdump', 'dumpert',
            'nanodump'
        }
        
        # Suspicious file patterns (higher scrutiny)
        self.suspicious_patterns = [
            'temp.exe', 'tmp.exe', 'cache.exe', 'update.exe', 'install.exe',
            'setup.exe', 'config.exe', 'service.exe', 'host.exe', 'manager.exe',
            'agent.exe', 'client.exe', 'server.exe', 'daemon.exe', 'worker.exe',
            'helper.exe', 'support.exe'
        ]
    
    def run(self):
        """Main aggressive protection loop - 10ms scanning"""
        print("[SMART-AGGRESSIVE] üöÄ Smart Aggressive Protection Active")
        print("[SMART-AGGRESSIVE] ‚ö° 10ms scanning - MAXIMUM malware detection")
        print("[SMART-AGGRESSIVE] üõ°Ô∏è Development tools protected by comprehensive whitelist")
        
        while self.running:
            try:
                self.aggressive_malware_scan()
                time.sleep(self.scan_interval)  # 10ms aggressive scanning
                
            except Exception as e:
                print(f"[SMART-AGGRESSIVE] Error: {e}")
                time.sleep(0.1)
    
    def aggressive_malware_scan(self):
        """Aggressive malware scanning with smart whitelisting"""
        try:
            for proc in psutil.process_iter(['pid', 'name', 'exe', 'cmdline']):
                try:
                    proc_info = proc.info
                    proc_name = proc_info['name'].lower() if proc_info['name'] else ''
                    
                    # FIRST: Check if whitelisted (CRITICAL - protect development tools)
                    if self.is_critical_process(proc_name, proc_info.get('exe')):
                        continue  # Skip whitelisted processes
                    
                    # SECOND: Aggressive malware detection
                    threat_level = self.analyze_threat_aggressively(proc_info)
                    
                    if threat_level == 'CRITICAL':
                        self.terminate_malware_immediately(proc_info)
                    elif threat_level == 'SUSPICIOUS':
                        self.monitor_suspicious_process(proc_info)
                        
                except (psutil.NoSuchProcess, psutil.AccessDenied):
                    continue
                    
        except Exception as e:
            print(f"[SMART-AGGRESSIVE] Scan error: {e}")
    
    def is_critical_process(self, process_name, exe_path=None):
        """Check if process is critical and should never be touched"""
        if not process_name:
            return False
        
        # Check against comprehensive whitelist
        for whitelist_item in self.critical_whitelist:
            if whitelist_item.lower() in process_name:
                return True
        
        # Check if in protected directory
        if exe_path:
            try:
                exe_path_obj = Path(exe_path)
                for protected_path in self.protected_paths:
                    if str(exe_path_obj).startswith(str(protected_path)):
                        return True
            except:
                pass
        
        return False
    
    def analyze_threat_aggressively(self, proc_info):
        """Aggressive threat analysis - catch malware fast"""
        proc_name = proc_info.get('name', '').lower()
        exe_path = proc_info.get('exe', '') or ''
        
        # Safe cmdline handling
        cmdline_raw = proc_info.get('cmdline', [])
        if cmdline_raw and hasattr(cmdline_raw, '__iter__') and not isinstance(cmdline_raw, str):
            try:
                cmdline = ' '.join(str(item) for item in cmdline_raw).lower()
            except (TypeError, AttributeError):
                cmdline = ''
        else:
            cmdline = str(cmdline_raw).lower() if cmdline_raw else ''
        
        # CRITICAL: Check for known malware signatures
        for malware_sig in self.malware_signatures:
            if malware_sig in proc_name or malware_sig in cmdline or malware_sig in exe_path.lower():
                return 'CRITICAL'
        
        # Check for suspicious patterns in temp directories
        if exe_path and any(temp_dir in exe_path.lower() for temp_dir in ['temp', 'tmp', 'appdata\\local\\temp']):
            for pattern in self.suspicious_patterns:
                if pattern in proc_name:
                    return 'SUSPICIOUS'
        
        # Check for suspicious file extensions
        if exe_path and any(ext in exe_path.lower() for ext in ['.tmp.exe', '.scr', '.pif', '.com']):
            return 'SUSPICIOUS'
        
        return 'SAFE'
    
    def terminate_malware_immediately(self, proc_info):
        """Immediately terminate confirmed malware"""
        pid = proc_info.get('pid')
        name = proc_info.get('name', 'unknown')
        
        try:
            print(f"[SMART-AGGRESSIVE] üö® MALWARE DETECTED: {name} (PID: {pid}) - TERMINATING IMMEDIATELY")
            
            # Terminate malware process
            proc = psutil.Process(pid)
            proc.terminate()
            
            # Wait for graceful termination
            try:
                proc.wait(timeout=2)
            except psutil.TimeoutExpired:
                proc.kill()  # Force kill if needed
                print(f"[SMART-AGGRESSIVE] ‚ö° Force killed malware: {name}")
            
            self.threat_detected.emit('CRITICAL', name, 'TERMINATED')
            print(f"[SMART-AGGRESSIVE] ‚úÖ Malware eliminated: {name}")
            
        except Exception as e:
            print(f"[SMART-AGGRESSIVE] Error terminating malware {name}: {e}")
    
    def monitor_suspicious_process(self, proc_info):
        """Monitor suspicious processes without immediate termination"""
        name = proc_info.get('name', 'unknown')
        pid = proc_info.get('pid')
        
        print(f"[SMART-AGGRESSIVE] ‚ö†Ô∏è SUSPICIOUS: {name} (PID: {pid}) - MONITORING")
        self.threat_detected.emit('SUSPICIOUS', name, 'MONITORING')
    
    def stop_protection(self):
        """Safely stop protection system"""
        print("[SMART-AGGRESSIVE] üõë Stopping smart aggressive protection...")
        self.running = False
        self.wait()
        print("[SMART-AGGRESSIVE] ‚úÖ Protection system stopped safely")

# Integration function
def start_smart_aggressive_protection():
    """Start the smart aggressive protection system"""
    protection = SmartAggressiveProtection()
    protection.start()
    return protection

if __name__ == "__main__":
    print("üöÄ Smart Aggressive Protection System")
    print("‚ö° Maximum malware detection with development tool protection")
    print("üõ°Ô∏è 10ms scanning + comprehensive whitelisting")
    
    protection = start_smart_aggressive_protection()
    
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        protection.stop_protection()
        print("\n‚úÖ Smart aggressive protection shut down cleanly")
