#!/usr/bin/env python3
"""
Install Process Daemon Service
Sets up the daemon to run automatically at boot
"""

import sys
import os
import subprocess
import winreg
from pathlib import Path
import win32serviceutil
import win32service

def install_daemon_service():
    """Install the Process Daemon Service"""
    print("üöÄ Installing Process Daemon Service...")
    
    try:
        # Get current directory
        current_dir = Path(__file__).parent
        service_script = current_dir / "process_daemon_service.py"
        
        if not service_script.exists():
            print(f"‚ùå Service script not found: {service_script}")
            return False
        
        # Install the service
        print("üì¶ Installing Windows service...")
        cmd = [
            sys.executable,
            str(service_script),
            "install"
        ]
        
        result = subprocess.run(cmd, capture_output=True, text=True)
        
        if result.returncode == 0:
            print("‚úÖ Service installed successfully")
            
            # Configure service for automatic startup
            print("üîß Configuring automatic startup...")
            try:
                # Set service to start automatically
                win32serviceutil.ChangeServiceConfig(
                    "ProcessDaemonService",
                    startType=win32service.SERVICE_AUTO_START,
                    description="Silent background malware analysis daemon with real-time threat detection"
                )
                print("‚úÖ Service configured for automatic startup")
                
                # Start the service
                print("üöÄ Starting daemon service...")
                win32serviceutil.StartService("ProcessDaemonService")
                print("‚úÖ Daemon service started successfully")
                
                return True
                
            except Exception as e:
                print(f"‚ö†Ô∏è Service configuration warning: {e}")
                return True  # Service installed but config failed
                
        else:
            print(f"‚ùå Service installation failed:")
            print(result.stderr)
            return False
            
    except Exception as e:
        print(f"‚ùå Installation error: {e}")
        return False

def setup_startup_registry():
    """Add tray app to Windows startup"""
    print("üîß Setting up tray app startup...")
    
    try:
        current_dir = Path(__file__).parent
        tray_script = current_dir / "process_manager_tray.py"
        python_exe = sys.executable
        
        # Create startup command
        startup_cmd = f'"{python_exe}" "{tray_script}"'
        
        # Add to Windows startup registry
        key_path = r"SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
        
        with winreg.OpenKey(winreg.HKEY_CURRENT_USER, key_path, 0, winreg.KEY_SET_VALUE) as key:
            winreg.SetValueEx(key, "ProcessManagerTray", 0, winreg.REG_SZ, startup_cmd)
        
        print("‚úÖ Tray app added to Windows startup")
        return True
        
    except Exception as e:
        print(f"‚ö†Ô∏è Startup registry setup failed: {e}")
        return False

def create_desktop_shortcuts():
    """Create desktop shortcuts"""
    print("üîó Creating desktop shortcuts...")
    
    try:
        import win32com.client
        
        desktop = Path.home() / "Desktop"
        current_dir = Path(__file__).parent
        
        # Create shortcut for tray app
        shell = win32com.client.Dispatch("WScript.Shell")
        shortcut = shell.CreateShortCut(str(desktop / "Process Manager Tray.lnk"))
        shortcut.Targetpath = sys.executable
        shortcut.Arguments = f'"{current_dir / "process_manager_tray.py"}'
        shortcut.WorkingDirectory = str(current_dir)
        shortcut.IconLocation = sys.executable
        shortcut.save()
        
        print("‚úÖ Desktop shortcuts created")
        return True
        
    except Exception as e:
        print(f"‚ö†Ô∏è Shortcut creation failed: {e}")
        return False

def main():
    """Main installation function"""
    print("=" * 60)
    print("üõ°Ô∏è  PROCESS DAEMON SERVICE INSTALLER")
    print("=" * 60)
    print()
    
    # Check admin privileges
    try:
        import ctypes
        is_admin = ctypes.windll.shell32.IsUserAnAdmin()
        if not is_admin:
            print("‚ö†Ô∏è Administrator privileges required for service installation")
            print("Please run this script as Administrator")
            input("Press Enter to exit...")
            return
    except:
        pass
    
    success_count = 0
    total_steps = 3
    
    # Step 1: Install daemon service
    if install_daemon_service():
        success_count += 1
    
    # Step 2: Setup startup registry
    if setup_startup_registry():
        success_count += 1
    
    # Step 3: Create shortcuts
    if create_desktop_shortcuts():
        success_count += 1
    
    print()
    print("=" * 60)
    print(f"üìä Installation Summary: {success_count}/{total_steps} steps completed")
    
    if success_count == total_steps:
        print("‚úÖ Process Daemon Service installation COMPLETE!")
        print()
        print("üéØ What happens now:")
        print("   ‚Ä¢ Daemon service runs silently in background")
        print("   ‚Ä¢ Automatically starts at boot")
        print("   ‚Ä¢ Tray app provides control and monitoring")
        print("   ‚Ä¢ Right-click tray ‚Üí 'Process Daemon' ‚Üí 'View Daemon Console'")
        print()
        print("üöÄ The daemon is now protecting your system!")
        
    elif success_count > 0:
        print("‚ö†Ô∏è Partial installation completed")
        print("Some features may not work correctly")
        
    else:
        print("‚ùå Installation failed")
        print("Please check error messages above")
    
    print()
    input("Press Enter to exit...")

if __name__ == "__main__":
    main()
