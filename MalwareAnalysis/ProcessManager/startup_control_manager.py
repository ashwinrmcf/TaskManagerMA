#!/usr/bin/env python3
"""
Startup Control Manager - Prevents aggressive protection systems from auto-starting
Ensures GUI starts smoothly without fortress systems causing freezes
"""

import os
import sys
import time
import json
from pathlib import Path
from PyQt5.QtCore import QObject, pyqtSignal, QTimer

class StartupControlManager(QObject):
    """Controls which protection systems start automatically"""
    
    startup_status = pyqtSignal(str, str)  # component, status
    
    def __init__(self):
        super().__init__()
        self.config_file = Path("F:/MalwareAnalysis/ProcessManager/startup_config.json")
        self.protection_components = {
            'fortress_protection_system': False,  # DISABLED - too aggressive
            'proactive_defense_system': False,   # DISABLED - too aggressive  
            'system_hardening_engine': False,    # DISABLED - too aggressive
            'safe_targeted_protection': True,    # ENABLED - safe version
            'volatility_bypass': True,           # ENABLED - essential
            'memory_dump_handler': True,         # ENABLED - core functionality
            'process_monitor': True              # ENABLED - core functionality
        }
        self.load_startup_config()
    
    def load_startup_config(self):
        """Load startup configuration from file"""
        try:
            if self.config_file.exists():
                with open(self.config_file, 'r') as f:
                    saved_config = json.load(f)
                    self.protection_components.update(saved_config)
                print("[STARTUP-CONTROL] ‚úÖ Loaded startup configuration")
            else:
                self.save_startup_config()
                print("[STARTUP-CONTROL] ‚úÖ Created default startup configuration")
        except Exception as e:
            print(f"[STARTUP-CONTROL] Error loading config: {e}")
    
    def save_startup_config(self):
        """Save startup configuration to file"""
        try:
            with open(self.config_file, 'w') as f:
                json.dump(self.protection_components, f, indent=2)
            print("[STARTUP-CONTROL] ‚úÖ Saved startup configuration")
        except Exception as e:
            print(f"[STARTUP-CONTROL] Error saving config: {e}")
    
    def should_start_component(self, component_name):
        """Check if a component should start automatically"""
        return self.protection_components.get(component_name, False)
    
    def disable_aggressive_components(self):
        """Disable all aggressive protection components"""
        aggressive_components = [
            'fortress_protection_system',
            'proactive_defense_system', 
            'system_hardening_engine'
        ]
        
        for component in aggressive_components:
            self.protection_components[component] = False
            self.startup_status.emit(component, "DISABLED")
            print(f"[STARTUP-CONTROL] üö´ Disabled aggressive component: {component}")
        
        self.save_startup_config()
    
    def enable_safe_components_only(self):
        """Enable only safe, essential components"""
        safe_components = {
            'safe_targeted_protection': True,
            'volatility_bypass': True,
            'memory_dump_handler': True,
            'process_monitor': True
        }
        
        for component, enabled in safe_components.items():
            self.protection_components[component] = enabled
            status = "ENABLED" if enabled else "DISABLED"
            self.startup_status.emit(component, status)
            print(f"[STARTUP-CONTROL] ‚úÖ {status}: {component}")
        
        self.save_startup_config()
    
    def get_startup_delay(self, component_name):
        """Get startup delay for component to prevent GUI freezing"""
        startup_delays = {
            'safe_targeted_protection': 5.0,    # 5 second delay
            'volatility_bypass': 0.0,           # No delay - essential
            'memory_dump_handler': 2.0,         # 2 second delay
            'process_monitor': 1.0              # 1 second delay
        }
        return startup_delays.get(component_name, 0.0)
    
    def create_safe_startup_sequence(self):
        """Create a safe startup sequence with delays"""
        print("[STARTUP-CONTROL] üöÄ Creating safe startup sequence...")
        
        # Disable aggressive components first
        self.disable_aggressive_components()
        
        # Create startup sequence with delays
        startup_sequence = []
        
        for component, enabled in self.protection_components.items():
            if enabled:
                delay = self.get_startup_delay(component)
                startup_sequence.append({
                    'component': component,
                    'delay': delay,
                    'enabled': enabled
                })
        
        # Sort by delay (start essential components first)
        startup_sequence.sort(key=lambda x: x['delay'])
        
        print("[STARTUP-CONTROL] ‚úÖ Safe startup sequence created:")
        for item in startup_sequence:
            print(f"  - {item['component']}: {item['delay']}s delay")
        
        return startup_sequence

class GUIStartupManager(QObject):
    """Manages GUI startup to prevent freezing"""
    
    gui_ready = pyqtSignal()
    
    def __init__(self):
        super().__init__()
        self.startup_control = StartupControlManager()
        self.startup_timers = []
    
    def start_gui_safely(self):
        """Start GUI with safe component loading"""
        print("[GUI-STARTUP] üöÄ Starting GUI safely...")
        
        # Get safe startup sequence
        startup_sequence = self.startup_control.create_safe_startup_sequence()
        
        # Schedule components with delays
        for item in startup_sequence:
            timer = QTimer()
            timer.setSingleShot(True)
            timer.timeout.connect(lambda comp=item['component']: self.start_component_safely(comp))
            timer.start(int(item['delay'] * 1000))  # Convert to milliseconds
            self.startup_timers.append(timer)
        
        print("[GUI-STARTUP] ‚úÖ GUI startup sequence initiated")
        self.gui_ready.emit()
    
    def start_component_safely(self, component_name):
        """Start a component safely with error handling"""
        try:
            print(f"[GUI-STARTUP] üîß Starting component: {component_name}")
            
            if component_name == 'safe_targeted_protection':
                from safe_targeted_protection import start_safe_protection
                protection = start_safe_protection()
                print(f"[GUI-STARTUP] ‚úÖ Started: {component_name}")
                
            elif component_name == 'volatility_bypass':
                print(f"[GUI-STARTUP] ‚úÖ Volatility bypass ready")
                
            # Add other safe components as needed
            
        except Exception as e:
            print(f"[GUI-STARTUP] ‚ùå Error starting {component_name}: {e}")
    
    def emergency_shutdown_aggressive_systems(self):
        """Emergency shutdown of any running aggressive systems"""
        print("[GUI-STARTUP] üö® Emergency shutdown of aggressive systems...")
        
        try:
            import psutil
            
            # Kill any aggressive protection processes
            aggressive_processes = [
                'fortress_protection_system',
                'proactive_defense_system',
                'system_hardening_engine'
            ]
            
            for proc in psutil.process_iter(['pid', 'name', 'cmdline']):
                try:
                    cmdline = ' '.join(proc.info.get('cmdline', []))
                    if any(aggressive in cmdline for aggressive in aggressive_processes):
                        print(f"[GUI-STARTUP] üõë Terminating aggressive process: {proc.info['name']}")
                        proc.terminate()
                except:
                    continue
                    
        except Exception as e:
            print(f"[GUI-STARTUP] Error in emergency shutdown: {e}")

# Integration functions
def initialize_safe_startup():
    """Initialize safe startup manager"""
    startup_manager = GUIStartupManager()
    
    # Emergency shutdown any running aggressive systems
    startup_manager.emergency_shutdown_aggressive_systems()
    
    # Start GUI safely
    startup_manager.start_gui_safely()
    
    return startup_manager

if __name__ == "__main__":
    print("üöÄ Startup Control Manager")
    print("‚úÖ Prevents aggressive protection systems from auto-starting")
    print("‚úÖ Ensures smooth GUI startup without freezing")
    
    # Initialize safe startup
    from PyQt5.QtWidgets import QApplication
    app = QApplication(sys.argv)
    
    startup_manager = initialize_safe_startup()
    
    print("‚úÖ Safe startup initialized - GUI should start smoothly")
    sys.exit(app.exec_())
