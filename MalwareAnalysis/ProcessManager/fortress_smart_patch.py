#!/usr/bin/env python3
"""
Fortress Smart Patch - Patches existing fortress protection with smart whitelisting
Maintains aggressive 10ms scanning while protecting development tools
"""

import sys
import time
import threading
from pathlib import Path

def patch_fortress_with_smart_whitelist():
    """Patch running fortress protection systems with smart whitelisting"""
    
    print("[FORTRESS-PATCH] üîß Patching fortress systems with smart whitelisting...")
    
    # Comprehensive whitelist for development tools
    CRITICAL_WHITELIST = {
        # Development Tools (HIGHEST PRIORITY)
        'windsurf.exe', 'windsurf', 'cascade.exe', 'cascade',
        'code.exe', 'code', 'devenv.exe', 'visual studio',
        'notepad++.exe', 'notepad.exe', 'sublime_text.exe',
        
        # Python Ecosystem (CRITICAL)
        'python.exe', 'pythonw.exe', 'python3.exe', 'python3',
        'pip.exe', 'pip3.exe', 'conda.exe', 'jupyter.exe',
        'ipython.exe', 'spyder.exe', 'pycharm.exe', 'pycharm64.exe',
        
        # System Processes (ESSENTIAL)
        'system', 'smss.exe', 'csrss.exe', 'wininit.exe', 'winlogon.exe',
        'services.exe', 'lsass.exe', 'svchost.exe', 'spoolsv.exe', 
        'explorer.exe', 'dwm.exe', 'taskhost.exe', 'taskhostw.exe',
        'audiodg.exe', 'conhost.exe', 'windefend.exe', 'msmpeng.exe',
        
        # Process Manager (Don't kill ourselves!)
        'process_manager_gui.exe', 'process_manager_gui.py'
    }
    
    # Protected directories
    PROTECTED_PATHS = {
        Path(sys.executable).parent,  # Python installation
        Path("C:/Windows/System32"),
        Path("C:/Windows/SysWOW64"),
        Path("C:/Program Files"),
        Path("C:/Program Files (x86)"),
        Path.home() / "AppData/Local/Programs"
    }
    
    def is_whitelisted_process(process_name, exe_path=None):
        """Check if process should be protected"""
        if not process_name:
            return False
            
        process_name = process_name.lower()
        
        # Check whitelist
        for whitelist_item in CRITICAL_WHITELIST:
            if whitelist_item.lower() in process_name:
                return True
        
        # Check protected paths
        if exe_path:
            try:
                exe_path_obj = Path(exe_path)
                for protected_path in PROTECTED_PATHS:
                    if str(exe_path_obj).startswith(str(protected_path)):
                        return True
            except:
                pass
        
        return False
    
    # Patch fortress protection systems
    try:
        if 'fortress_protection_system' in sys.modules:
            fortress_module = sys.modules['fortress_protection_system']
            print("[FORTRESS-PATCH] üì¶ Found fortress_protection_system module")
            
            # Patch FortressProtectionSystem if it exists
            if hasattr(fortress_module, 'FortressProtectionSystem'):
                FortressProtectionSystem = fortress_module.FortressProtectionSystem
                
                # Store original methods
                if not hasattr(FortressProtectionSystem, '_original_terminate_threat'):
                    FortressProtectionSystem._original_terminate_threat = FortressProtectionSystem.terminate_threat
                
                def smart_terminate_threat(self, proc_info, threat_level):
                    """Smart termination with whitelisting"""
                    proc_name = proc_info.get('name', '')
                    exe_path = proc_info.get('exe', '')
                    
                    # Check whitelist first
                    if is_whitelisted_process(proc_name, exe_path):
                        print(f"[FORTRESS-PATCH] üõ°Ô∏è PROTECTED: {proc_name} - whitelisted")
                        return False
                    
                    # Only terminate if not whitelisted
                    return self._original_terminate_threat(proc_info, threat_level)
                
                # Apply patch
                FortressProtectionSystem.terminate_threat = smart_terminate_threat
                print("[FORTRESS-PATCH] ‚úÖ Patched FortressProtectionSystem.terminate_threat")
        
        # Patch proactive defense system
        if 'proactive_defense_system' in sys.modules:
            proactive_module = sys.modules['proactive_defense_system']
            print("[FORTRESS-PATCH] üì¶ Found proactive_defense_system module")
            
            if hasattr(proactive_module, 'ProactiveDefenseSystem'):
                ProactiveDefenseSystem = proactive_module.ProactiveDefenseSystem
                
                # Store original methods
                if not hasattr(ProactiveDefenseSystem, '_original_prevent_execution'):
                    ProactiveDefenseSystem._original_prevent_execution = ProactiveDefenseSystem.prevent_execution
                
                def smart_prevent_execution(self, file_path):
                    """Smart prevention with whitelisting"""
                    if is_whitelisted_process(Path(file_path).name, file_path):
                        print(f"[FORTRESS-PATCH] üõ°Ô∏è ALLOWED: {file_path} - whitelisted")
                        return False
                    
                    return self._original_prevent_execution(file_path)
                
                # Apply patch
                ProactiveDefenseSystem.prevent_execution = smart_prevent_execution
                print("[FORTRESS-PATCH] ‚úÖ Patched ProactiveDefenseSystem.prevent_execution")
        
        # Patch system hardening engine
        if 'system_hardening_engine' in sys.modules:
            hardening_module = sys.modules['system_hardening_engine']
            print("[FORTRESS-PATCH] üì¶ Found system_hardening_engine module")
            
            if hasattr(hardening_module, 'SystemHardeningEngine'):
                SystemHardeningEngine = hardening_module.SystemHardeningEngine
                
                # Store original methods
                if not hasattr(SystemHardeningEngine, '_original_enforce_policy'):
                    SystemHardeningEngine._original_enforce_policy = SystemHardeningEngine.enforce_policy
                
                def smart_enforce_policy(self, process_info):
                    """Smart policy enforcement with whitelisting"""
                    proc_name = process_info.get('name', '')
                    exe_path = process_info.get('exe', '')
                    
                    if is_whitelisted_process(proc_name, exe_path):
                        print(f"[FORTRESS-PATCH] üõ°Ô∏è POLICY EXEMPT: {proc_name} - whitelisted")
                        return True
                    
                    return self._original_enforce_policy(process_info)
                
                # Apply patch
                SystemHardeningEngine.enforce_policy = smart_enforce_policy
                print("[FORTRESS-PATCH] ‚úÖ Patched SystemHardeningEngine.enforce_policy")
        
        print("[FORTRESS-PATCH] üöÄ All fortress systems patched with smart whitelisting")
        print("[FORTRESS-PATCH] ‚ö° Aggressive malware detection ACTIVE")
        print("[FORTRESS-PATCH] üõ°Ô∏è Development tools PROTECTED")
        
        return True
        
    except Exception as e:
        print(f"[FORTRESS-PATCH] ‚ùå Patch failed: {e}")
        return False

def enable_smart_aggressive_mode():
    """Enable smart aggressive mode in the GUI"""
    try:
        # Import and start smart aggressive protection
        from smart_aggressive_protection import start_smart_aggressive_protection
        
        print("[SMART-MODE] üöÄ Starting Smart Aggressive Protection...")
        protection = start_smart_aggressive_protection()
        
        # Also patch existing fortress systems
        patch_fortress_with_smart_whitelist()
        
        return protection
        
    except Exception as e:
        print(f"[SMART-MODE] ‚ùå Failed to enable smart aggressive mode: {e}")
        return None

if __name__ == "__main__":
    print("üîß Fortress Smart Patch")
    print("‚ö° Patches fortress systems with development tool protection")
    
    success = patch_fortress_with_smart_whitelist()
    if success:
        print("‚úÖ Fortress systems successfully patched")
    else:
        print("‚ùå Patch failed")
