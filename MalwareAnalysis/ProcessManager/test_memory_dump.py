#!/usr/bin/env python3
"""
Test script to demonstrate the optimized memory dump functionality.
This script simulates the memory dump process to show the improvements.
"""

import sys
import os
import time
from pathlib import Path

# Add the current directory to Python path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from core.models.process import MemoryDumpWorker
from PyQt5.QtCore import QCoreApplication

def test_memory_dump():
    """Test the memory dump functionality with a sample PID."""
    
    print("üöÄ Testing Lightning-Fast Memory Dump System")
    print("=" * 50)
    
    # Create QApplication for Qt signals
    app = QCoreApplication(sys.argv)
    
    # Get a sample PID (current process)
    current_pid = os.getpid()
    print(f"üìã Testing with PID: {current_pid} (current Python process)")
    
    # Set up dump directory
    dump_dir = Path(r"F:\MalwareAnalysis\MemDump")
    dump_dir.mkdir(parents=True, exist_ok=True)
    
    # Create memory dump worker
    worker = MemoryDumpWorker([current_pid], dump_dir)
    
    # Connect signals for logging
    def log_handler(message):
        print(f"üìù {message}")
    
    def progress_handler(percent):
        print(f"‚ö° Progress: {percent}%")
    
    def error_handler(title, message):
        print(f"‚ùå Error - {title}: {message}")
    
    def finished_handler():
        print("‚úÖ Memory dump process completed!")
        app.quit()
    
    # Connect signals
    worker.log_message.connect(log_handler)
    worker.progress_update.connect(progress_handler)
    worker.error_signal.connect(error_handler)
    worker.finished.connect(finished_handler)
    
    print("\nüîç Starting memory dump test...")
    print("This will test the optimized memory dump system with proper WinPmem handling.")
    print("The system will now:")
    print("1. Check available tools (WinPmem, ProcDump, Direct API)")
    print("2. Select the best strategy based on PID count and available tools")
    print("3. Execute the memory dump with proper exit code handling")
    print("4. Verify file creation instead of relying on exit codes")
    print()
    
    # Start the worker
    worker.start()
    
    # Run the event loop
    app.exec_()
    
    print("\nüéâ Test completed!")
    print("The memory dump system has been optimized to handle WinPmem exit codes correctly.")
    print("Check the MemDump directory for the generated files.")

if __name__ == "__main__":
    test_memory_dump()
