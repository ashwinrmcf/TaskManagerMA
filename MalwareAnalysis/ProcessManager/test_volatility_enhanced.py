import sys
import os
import json
import subprocess
from pathlib import Path
from PyQt5.QtWidgets import QApplication
from PyQt5.QtCore import QObject, pyqtSignal, QThread, QProcess

# Add the current directory to Python path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# Import the VolatilityWorker class from process_manager_gui.py
from process_manager_gui import VolatilityWorker

class VolatilityTester(QObject):
    def __init__(self, dump_file):
        super().__init__()
        self.dump_file = Path(dump_file)
        self.app = QApplication.instance() or QApplication(sys.argv)
        self.worker = None
        self.config = self.load_config()
        
    def load_config(self):
        config_path = Path(__file__).parent / "volatility_config.json"
        if config_path.exists():
            try:
                with open(config_path, 'r') as f:
                    return json.load(f)
            except Exception as e:
                print(f"‚ö†Ô∏è Error loading config: {e}")
        return {}
        
    def run_analysis(self):
        print(f"üöÄ Starting Volatility analysis on: {self.dump_file}")
        print(f"üîß Using config: {self.config}")
        
        # Try Volatility 3 first with specific commands
        if self.run_vol3_specific_commands():
            print("‚úÖ Volatility 3 analysis completed successfully")
            return
            
        # Fall back to direct command execution if worker fails
        print("‚ö†Ô∏è Falling back to direct command execution...")
        self.run_direct_commands()
    
    def run_vol3_specific_commands(self):
        """Run specific Volatility 3 commands that are known to work"""
        commands = [
            "windows.info",
            "windows.pslist",
            "windows.pstree",
            "windows.netscan",
            "windows.malfind",
            "windows.handles",
            "windows.driverscan"
        ]
        
        print("\nüîç Running Volatility 3 with specific commands...")
        success = True
        
        for cmd in commands:
            print(f"\n=== {cmd.upper()} ===")
            try:
                result = self.run_single_command(cmd)
                if result.returncode != 0:
                    print(f"‚ùå {cmd} failed with return code {result.returncode}")
                    print(f"Stderr: {result.stderr}")
                    success = False
                else:
                    print(result.stdout)
            except Exception as e:
                print(f"‚ùå Error running {cmd}: {str(e)}")
                success = False
                
        return success
    
    def run_single_command(self, plugin):
        """Run a single Volatility 3 command"""
        vol3_path = self.config.get("volatility3_path", r"F:\MalwareAnalysis\Tools\volatility3\vol.py")
        cmd = [
            sys.executable,
            vol3_path,
            "-f", str(self.dump_file),
            plugin
        ]
        
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            encoding='utf-8',
            errors='replace'
        )
        return result
    
    def run_direct_commands(self):
        """Run direct commands as a last resort"""
        print("\nüîÑ Running direct commands...")
        
        # Basic system info
        try:
            print("\n=== SYSTEM INFO ===")
            result = subprocess.run(
                ["systeminfo"],
                capture_output=True,
                text=True,
                encoding='utf-8',
                errors='replace'
            )
            print(result.stdout)
        except Exception as e:
            print(f"‚ùå Error getting system info: {str(e)}")

        # Network connections
        try:
            print("\n=== NETWORK CONNECTIONS ===")
            result = subprocess.run(
                ["netstat", "-ano"],
                capture_output=True,
                text=True,
                encoding='utf-8',
                errors='replace'
            )
            print(result.stdout)
        except Exception as e:
            print(f"‚ùå Error getting network info: {str(e)}")

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python test_volatility_enhanced.py <path_to_dump_file>")
        sys.exit(1)
    
    dump_file = sys.argv[1]
    if not os.path.exists(dump_file):
        print(f"‚ùå Error: File not found: {dump_file}")
        sys.exit(1)
        
    tester = VolatilityTester(dump_file)
    tester.run_analysis()
