#!/usr/bin/env python3
"""
Safe Targeted Protection System - Surgical precision against threats only
Protects against malware while preserving system stability and legitimate applications
"""

import os
import sys
import time
import psutil
import threading
import subprocess
from pathlib import Path
from PyQt5.QtCore import QThread, pyqtSignal

class SafeTargetedProtection(QThread):
    """Safe protection system that only targets actual threats"""
    
    threat_detected = pyqtSignal(str, str, str)  # threat_type, process_name, action
    
    def __init__(self):
        super().__init__()
        self.running = True
        self.scan_interval = 2.0  # 2 second intervals - much gentler
        
        # CRITICAL: Whitelist legitimate system processes and development tools
        self.system_whitelist = {
            # Windows System Processes
            'system', 'smss.exe', 'csrss.exe', 'wininit.exe', 'winlogon.exe',
            'services.exe', 'lsass.exe', 'svchost.exe', 'spoolsv.exe', 'explorer.exe',
            'dwm.exe', 'taskhost.exe', 'taskhostw.exe', 'audiodg.exe', 'conhost.exe',
            
            # Development Tools (CRITICAL - Don't break development environment)
            'python.exe', 'pythonw.exe', 'node.exe', 'code.exe', 'devenv.exe',
            'windsurf.exe', 'cascade.exe', 'git.exe', 'npm.exe', 'pip.exe',
            'powershell.exe', 'cmd.exe', 'notepad.exe', 'notepad++.exe',
            
            # Browsers and Common Apps
            'chrome.exe', 'firefox.exe', 'msedge.exe', 'iexplore.exe',
            'discord.exe', 'teams.exe', 'zoom.exe', 'vlc.exe',
            
            # Security and System Tools
            'msiexec.exe', 'wuauclt.exe', 'windefend.exe', 'msmpeng.exe',
            'antimalware service executable', 'windows security health service',
            
            # Process Manager Components (Don't kill ourselves!)
            'process_manager_gui.exe', 'process_manager_gui.py'
        }
        
        # Protected directories - READ ONLY monitoring, NO deletion
        self.protected_paths = {
            Path(sys.executable).parent,  # Python installation
            Path("C:/Windows/System32"),
            Path("C:/Program Files"),
            Path("C:/Program Files (x86)"),
            Path.home() / "AppData/Local/Programs"  # User applications
        }
        
        # Known malware signatures (ONLY target these specific threats)
        self.malware_signatures = {
            'satan', 'ransomware', 'keylogger', 'backdoor', 'trojan',
            'cryptolocker', 'wannacry', 'petya', 'notpetya', 'ryuk'
        }
        
        # Suspicious behavior patterns (monitor only, don't auto-kill)
        self.suspicious_patterns = [
            'encrypt', 'decrypt', 'bitcoin', 'ransom', 'payload'
        ]
        
    def run(self):
        """Main protection loop - gentle and targeted"""
        print("[SAFE-PROTECTION] üõ°Ô∏è Safe Targeted Protection Active")
        print("[SAFE-PROTECTION] ‚úÖ System processes whitelisted")
        print("[SAFE-PROTECTION] ‚úÖ Development tools protected")
        
        while self.running:
            try:
                self.scan_for_actual_threats()
                time.sleep(self.scan_interval)  # Gentle 2-second intervals
                
            except Exception as e:
                print(f"[SAFE-PROTECTION] Error: {e}")
                time.sleep(5.0)  # Longer delay on errors
    
    def scan_for_actual_threats(self):
        """Scan for actual malware threats only"""
        try:
            current_processes = []
            
            for proc in psutil.process_iter(['pid', 'name', 'exe', 'cmdline']):
                try:
                    proc_info = proc.info
                    proc_name = proc_info['name'].lower() if proc_info['name'] else ''
                    
                    # SKIP if whitelisted (CRITICAL - don't touch system processes)
                    if self.is_whitelisted(proc_name):
                        continue
                    
                    # SKIP if in protected directory
                    if self.is_in_protected_directory(proc_info.get('exe')):
                        continue
                    
                    # Only flag if ACTUALLY suspicious
                    threat_level = self.analyze_threat_level(proc_info)
                    
                    if threat_level == 'CRITICAL':
                        self.handle_critical_threat(proc_info)
                    elif threat_level == 'SUSPICIOUS':
                        self.monitor_suspicious_process(proc_info)
                        
                except (psutil.NoSuchProcess, psutil.AccessDenied):
                    continue
                    
        except Exception as e:
            print(f"[SAFE-PROTECTION] Scan error: {e}")
    
    def is_whitelisted(self, process_name):
        """Check if process is whitelisted (system/development tool)"""
        return any(whitelist_name in process_name for whitelist_name in self.system_whitelist)
    
    def is_in_protected_directory(self, exe_path):
        """Check if executable is in a protected system directory"""
        if not exe_path:
            return False
            
        try:
            exe_path = Path(exe_path)
            return any(str(exe_path).startswith(str(protected)) for protected in self.protected_paths)
        except:
            return False
    
    def analyze_threat_level(self, proc_info):
        """Analyze actual threat level - be conservative"""
        proc_name = proc_info.get('name', '').lower()
        exe_path = proc_info.get('exe', '')
        cmdline = ' '.join(proc_info.get('cmdline', [])).lower()
        
        # CRITICAL: Only flag if DEFINITELY malicious
        for malware_sig in self.malware_signatures:
            if malware_sig in proc_name or malware_sig in cmdline:
                return 'CRITICAL'
        
        # Check for suspicious patterns (but don't auto-kill)
        for pattern in self.suspicious_patterns:
            if pattern in proc_name or pattern in cmdline:
                # Additional checks to avoid false positives
                if self.additional_malware_checks(proc_info):
                    return 'SUSPICIOUS'
        
        return 'SAFE'
    
    def additional_malware_checks(self, proc_info):
        """Additional checks to confirm malware (avoid false positives)"""
        exe_path = proc_info.get('exe', '')
        
        # Check if in temp directories (more suspicious)
        if exe_path and any(temp_dir in exe_path.lower() for temp_dir in ['temp', 'tmp', 'appdata\\local\\temp']):
            return True
        
        # Check for suspicious file extensions
        if exe_path and any(ext in exe_path.lower() for ext in ['.tmp.exe', '.scr', '.pif', '.com']):
            return True
            
        return False
    
    def handle_critical_threat(self, proc_info):
        """Handle confirmed critical threats"""
        pid = proc_info.get('pid')
        name = proc_info.get('name', 'unknown')
        
        try:
            print(f"[SAFE-PROTECTION] üö® CRITICAL THREAT: {name} (PID: {pid})")
            
            # Terminate only confirmed threats
            proc = psutil.Process(pid)
            proc.terminate()
            
            # Wait for graceful termination
            try:
                proc.wait(timeout=3)
            except psutil.TimeoutExpired:
                proc.kill()  # Force kill if needed
            
            self.threat_detected.emit('CRITICAL', name, 'TERMINATED')
            print(f"[SAFE-PROTECTION] ‚úÖ Terminated critical threat: {name}")
            
        except Exception as e:
            print(f"[SAFE-PROTECTION] Error terminating {name}: {e}")
    
    def monitor_suspicious_process(self, proc_info):
        """Monitor suspicious processes (don't auto-kill)"""
        name = proc_info.get('name', 'unknown')
        pid = proc_info.get('pid')
        
        print(f"[SAFE-PROTECTION] ‚ö†Ô∏è MONITORING suspicious: {name} (PID: {pid})")
        self.threat_detected.emit('SUSPICIOUS', name, 'MONITORING')
    
    def stop_protection(self):
        """Safely stop protection system"""
        print("[SAFE-PROTECTION] üõë Stopping safe protection system...")
        self.running = False
        self.wait()  # Wait for thread to finish
        print("[SAFE-PROTECTION] ‚úÖ Protection system stopped safely")

# Integration function
def start_safe_protection():
    """Start the safe targeted protection system"""
    protection = SafeTargetedProtection()
    protection.start()
    return protection

if __name__ == "__main__":
    print("üõ°Ô∏è Safe Targeted Protection System")
    print("‚úÖ Protects against malware while preserving system stability")
    print("‚úÖ Whitelists system processes and development tools")
    print("‚úÖ Gentle scanning intervals to prevent system freezing")
    
    protection = start_safe_protection()
    
    try:
        # Keep running until interrupted
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        protection.stop_protection()
        print("\n‚úÖ Safe protection system shut down cleanly")
