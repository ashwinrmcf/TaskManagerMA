import os
import re
import psutil
import subprocess

def capture_memory_dump(dump_path='memory_dump.raw'):
    """Captures a memory dump to the specified path."""
    print(f"Capturing memory dump to {dump_path}...")
    result = subprocess.run(["winpmem_mini.exe", dump_path])
def analyze_memory_dump(dump_path=r'memory_dump.raw'):
    """Analyzes the memory dump for malicious processes using Volatility."""
    print(f"Analyzing memory dump {dump_path} for malicious processes...")
    result = subprocess.run([
        r"python", 
        r"C:\volatility3-develop\volatility3-develop\vol.py", 
        "-f", 
        dump_path, 
        "windows.malfind.Malfind"
    ], capture_output=True, text=True)
    
    return result.stdout

# List of essential processes to exclude
essential_processes = {
    "System Idle Process",
    "System",
    "smss.exe",
    "csrss.exe",
    "wininit.exe",
    "services.exe",
    "lsass.exe",
    "svchost.exe",
    "explorer.exe",
    "MsMpEng.exe"  # Windows Defender, if applicable
}

def get_process_name(pid):
    """Retrieve the process name for a given PID."""
    try:
        process = psutil.Process(pid)
        return process.name()
    except psutil.NoSuchProcess:
        return None
    except psutil.AccessDenied:
        return None

def extract_malicious_pids(volatility_output):
    """
    Extracts 4-digit PIDs from the given Volatility output while excluding essential system processes.

    Args:
        volatility_output (str): The raw output from a Volatility command.

    Returns:
        List[int]: A list of 4-digit PIDs extracted from the output, excluding essential processes.
    """
    lines = volatility_output.splitlines()
    numbers_list = []
    
    for line in lines:
        # Use regex to find 4-digit numbers at the beginning of the line
        match = re.match(r'^(\d{4})', line)
        if match:
            pid = int(match.group(1))
            process_name = get_process_name(pid)
            if process_name and process_name not in essential_processes:
                # Append the PID to the list if it's not an essential process
                numbers_list.append(pid)
    
    print(numbers_list)
    return numbers_list

def kill_malicious_processes():
    """Captures a memory dump, analyzes it, and kills malicious processes."""
    dump_path = 'memory_dump.raw'
    capture_memory_dump(dump_path)

    volatility_output = analyze_memory_dump(dump_path)
    malicious_pids = extract_malicious_pids(volatility_output)

    killed_processes = []
    for pid in malicious_pids:
        try:
            proc = psutil.Process(pid)
            proc_name = proc.name()
            proc.terminate()  # Attempt to terminate the process
            proc.wait(timeout=5)  # Wait for the process to terminate
            killed_processes.append((pid, proc_name))
            print(f"Killed malicious process {proc_name} (PID: {pid})")
        except psutil.NoSuchProcess:
            print(f"Process with PID {pid} no longer exists.")
        except psutil.AccessDenied:
            print(f"Access denied: Could not terminate process with PID {pid}.")
        except psutil.ZombieProcess:
            print(f"Process with PID {pid} is a zombie process.")
        except PermissionError:
            print(f"Permission denied: Could not terminate process with PID {pid}.")
        except Exception as e:
            print(f"An error occurred with PID {pid}: {e}")

    print("\nList of processes killed:")
    for pid, proc_name in killed_processes:
        print(f"Process: {proc_name}, PID: {pid}")

if __name__ == "__main__":
    kill_malicious_processes()
