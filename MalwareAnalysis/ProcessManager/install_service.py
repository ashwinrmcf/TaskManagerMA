#!/usr/bin/env python3
"""
Process Manager Service Installer
Installs, configures, and manages the Process Manager Windows Service
"""

import sys
import os
import subprocess
import winreg
from pathlib import Path
import win32serviceutil
import win32service
import win32api
import win32con
import shutil

class ServiceInstaller:
    """Handles installation and configuration of Process Manager Service"""
    
    def __init__(self):
        self.service_name = "ProcessManagerService"
        self.service_display_name = "Process Manager Malware Analysis Service"
        self.service_description = "Automated malware detection and analysis service with memory forensics capabilities"
        self.current_dir = Path(__file__).parent.absolute()
        self.service_script = self.current_dir / "process_manager_service.py"
        self.tray_script = self.current_dir / "process_manager_tray.py"
        
    def check_admin_privileges(self):
        """Check if running with administrator privileges"""
        try:
            import ctypes
            return ctypes.windll.shell32.IsUserAnAdmin()
        except:
            return False
    
    def require_admin(self):
        """Require administrator privileges"""
        if not self.check_admin_privileges():
            print("‚ùå Administrator privileges required!")
            print("Please run this script as Administrator")
            input("Press Enter to exit...")
            sys.exit(1)
    
    def install_service(self):
        """Install the Windows service"""
        print("üîß Installing Process Manager Service...")
        
        try:
            # Install the service
            win32serviceutil.InstallService(
                pythonClassString=f"{self.service_script.stem}.ProcessManagerService",
                serviceName=self.service_name,
                displayName=self.service_display_name,
                startType=win32service.SERVICE_AUTO_START,
                description=self.service_description,
                exeName=sys.executable,
                exeArgs=f'"{self.service_script}"'
            )
            
            print("‚úÖ Service installed successfully")
            
            # Configure service recovery options
            self.configure_service_recovery()
            
            # Set service to start automatically
            self.configure_auto_start()
            
            return True
            
        except Exception as e:
            print(f"‚ùå Error installing service: {e}")
            return False
    
    def uninstall_service(self):
        """Uninstall the Windows service"""
        print("üóëÔ∏è Uninstalling Process Manager Service...")
        
        try:
            # Stop service if running
            try:
                win32serviceutil.StopService(self.service_name)
                print("üõë Service stopped")
            except:
                pass
            
            # Remove service
            win32serviceutil.RemoveService(self.service_name)
            print("‚úÖ Service uninstalled successfully")
            
            # Remove startup registry entries
            self.remove_startup_entries()
            
            return True
            
        except Exception as e:
            print(f"‚ùå Error uninstalling service: {e}")
            return False
    
    def configure_service_recovery(self):
        """Configure service recovery options"""
        try:
            # Set service to restart on failure
            cmd = [
                'sc', 'failure', self.service_name,
                'reset=', '86400',  # Reset failure count after 24 hours
                'actions=', 'restart/5000/restart/10000/restart/30000'  # Restart after 5s, 10s, 30s
            ]
            
            result = subprocess.run(cmd, capture_output=True, text=True)
            if result.returncode == 0:
                print("‚úÖ Service recovery configured")
            else:
                print(f"‚ö†Ô∏è Warning: Could not configure service recovery: {result.stderr}")
                
        except Exception as e:
            print(f"‚ö†Ô∏è Warning: Error configuring service recovery: {e}")
    
    def configure_auto_start(self):
        """Configure service to start automatically"""
        try:
            # Set service startup type to automatic
            win32serviceutil.ChangeServiceConfig(
                serviceName=self.service_name,
                startType=win32service.SERVICE_AUTO_START
            )
            print("‚úÖ Service configured for automatic startup")
            
        except Exception as e:
            print(f"‚ö†Ô∏è Warning: Error configuring auto-start: {e}")
    
    def install_tray_startup(self):
        """Install tray application to start with Windows"""
        print("üñ•Ô∏è Configuring tray application startup...")
        
        try:
            # Add to Windows startup registry
            key_path = r"SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
            
            with winreg.OpenKey(winreg.HKEY_CURRENT_USER, key_path, 0, winreg.KEY_SET_VALUE) as key:
                tray_command = f'"{sys.executable}" "{self.tray_script}"'
                winreg.SetValueEx(key, "ProcessManagerTray", 0, winreg.REG_SZ, tray_command)
            
            print("‚úÖ Tray application configured for startup")
            return True
            
        except Exception as e:
            print(f"‚ùå Error configuring tray startup: {e}")
            return False
    
    def remove_startup_entries(self):
        """Remove startup registry entries"""
        try:
            key_path = r"SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
            
            with winreg.OpenKey(winreg.HKEY_CURRENT_USER, key_path, 0, winreg.KEY_SET_VALUE) as key:
                try:
                    winreg.DeleteValue(key, "ProcessManagerTray")
                    print("‚úÖ Tray startup entry removed")
                except FileNotFoundError:
                    pass  # Entry doesn't exist
                    
        except Exception as e:
            print(f"‚ö†Ô∏è Warning: Error removing startup entries: {e}")
    
    def start_service(self):
        """Start the service"""
        print("‚ñ∂Ô∏è Starting Process Manager Service...")
        
        try:
            win32serviceutil.StartService(self.service_name)
            print("‚úÖ Service started successfully")
            return True
        except Exception as e:
            print(f"‚ùå Error starting service: {e}")
            return False
    
    def stop_service(self):
        """Stop the service"""
        print("‚èπÔ∏è Stopping Process Manager Service...")
        
        try:
            win32serviceutil.StopService(self.service_name)
            print("‚úÖ Service stopped successfully")
            return True
        except Exception as e:
            print(f"‚ùå Error stopping service: {e}")
            return False
    
    def check_service_status(self):
        """Check service status"""
        try:
            status = win32serviceutil.QueryServiceStatus(self.service_name)
            state = status[1]
            
            if state == win32service.SERVICE_RUNNING:
                return "Running"
            elif state == win32service.SERVICE_STOPPED:
                return "Stopped"
            elif state == win32service.SERVICE_START_PENDING:
                return "Starting"
            elif state == win32service.SERVICE_STOP_PENDING:
                return "Stopping"
            else:
                return "Unknown"
                
        except Exception:
            return "Not Installed"
    
    def create_desktop_shortcuts(self):
        """Create desktop shortcuts"""
        print("üîó Creating desktop shortcuts...")
        
        try:
            import win32com.client
            
            desktop = Path.home() / "Desktop"
            
            # Create tray application shortcut
            shell = win32com.client.Dispatch("WScript.Shell")
            shortcut = shell.CreateShortCut(str(desktop / "Process Manager Tray.lnk"))
            shortcut.Targetpath = sys.executable
            shortcut.Arguments = f'"{self.tray_script}"'
            shortcut.WorkingDirectory = str(self.current_dir)
            shortcut.IconLocation = sys.executable
            shortcut.Description = "Process Manager System Tray"
            shortcut.save()
            
            print("‚úÖ Desktop shortcuts created")
            return True
            
        except Exception as e:
            print(f"‚ö†Ô∏è Warning: Could not create shortcuts: {e}")
            return False
    
    def verify_dependencies(self):
        """Verify required dependencies are installed"""
        print("üîç Verifying dependencies...")
        
        required_modules = [
            'psutil', 'win32serviceutil', 'win32service', 'win32event',
            'PyQt5', 'pathlib', 'json', 'threading'
        ]
        
        missing_modules = []
        
        for module in required_modules:
            try:
                __import__(module)
            except ImportError:
                missing_modules.append(module)
        
        if missing_modules:
            print(f"‚ùå Missing required modules: {', '.join(missing_modules)}")
            print("Please install missing dependencies with:")
            print(f"pip install {' '.join(missing_modules)}")
            return False
        
        print("‚úÖ All dependencies verified")
        return True
    
    def create_startup_batch(self):
        """Create batch file for easy startup"""
        batch_content = f'''@echo off
echo Starting Process Manager Service...
net start {self.service_name}
if %errorlevel% == 0 (
    echo Service started successfully
    echo Starting tray application...
    start "" "{sys.executable}" "{self.tray_script}"
) else (
    echo Failed to start service
    pause
)
'''
        
        batch_file = self.current_dir / "start_process_manager.bat"
        try:
            with open(batch_file, 'w') as f:
                f.write(batch_content)
            print(f"‚úÖ Startup batch file created: {batch_file}")
        except Exception as e:
            print(f"‚ö†Ô∏è Warning: Could not create batch file: {e}")
    
    def full_install(self):
        """Perform complete installation"""
        print("=" * 60)
        print("üöÄ Process Manager Service - Full Installation")
        print("=" * 60)
        
        self.require_admin()
        
        if not self.verify_dependencies():
            return False
        
        # Install service
        if not self.install_service():
            return False
        
        # Configure tray startup
        self.install_tray_startup()
        
        # Create shortcuts
        self.create_desktop_shortcuts()
        
        # Create startup batch
        self.create_startup_batch()
        
        # Start service
        self.start_service()
        
        print("\n" + "=" * 60)
        print("‚úÖ Installation completed successfully!")
        print("=" * 60)
        print("üìã What's installed:")
        print("   ‚Ä¢ Windows Service (auto-start enabled)")
        print("   ‚Ä¢ System Tray Application (startup configured)")
        print("   ‚Ä¢ Desktop shortcuts")
        print("   ‚Ä¢ Startup batch file")
        print("\nüîß Service will start automatically at boot")
        print("üñ•Ô∏è Tray application will start with Windows login")
        print("üõ°Ô∏è Your system is now protected!")
        
        return True
    
    def full_uninstall(self):
        """Perform complete uninstallation"""
        print("=" * 60)
        print("üóëÔ∏è Process Manager Service - Full Uninstallation")
        print("=" * 60)
        
        self.require_admin()
        
        # Uninstall service
        self.uninstall_service()
        
        # Remove startup entries
        self.remove_startup_entries()
        
        # Remove shortcuts
        try:
            desktop = Path.home() / "Desktop"
            shortcut = desktop / "Process Manager Tray.lnk"
            if shortcut.exists():
                shortcut.unlink()
                print("‚úÖ Desktop shortcuts removed")
        except Exception as e:
            print(f"‚ö†Ô∏è Warning: Could not remove shortcuts: {e}")
        
        print("\n" + "=" * 60)
        print("‚úÖ Uninstallation completed successfully!")
        print("=" * 60)
        
        return True

def main():
    """Main installer interface"""
    installer = ServiceInstaller()
    
    if len(sys.argv) > 1:
        command = sys.argv[1].lower()
        
        if command == "install":
            installer.full_install()
        elif command == "uninstall":
            installer.full_uninstall()
        elif command == "start":
            installer.start_service()
        elif command == "stop":
            installer.stop_service()
        elif command == "status":
            status = installer.check_service_status()
            print(f"Service Status: {status}")
        else:
            print("Usage: python install_service.py [install|uninstall|start|stop|status]")
    else:
        # Interactive mode
        print("=" * 60)
        print("üõ°Ô∏è Process Manager Service Installer")
        print("=" * 60)
        
        status = installer.check_service_status()
        print(f"Current Status: {status}")
        
        print("\nOptions:")
        print("1. Full Install (Service + Tray + Auto-start)")
        print("2. Uninstall Everything")
        print("3. Start Service")
        print("4. Stop Service")
        print("5. Check Status")
        print("6. Exit")
        
        while True:
            try:
                choice = input("\nSelect option (1-6): ").strip()
                
                if choice == "1":
                    installer.full_install()
                    break
                elif choice == "2":
                    installer.full_uninstall()
                    break
                elif choice == "3":
                    installer.start_service()
                elif choice == "4":
                    installer.stop_service()
                elif choice == "5":
                    status = installer.check_service_status()
                    print(f"Service Status: {status}")
                elif choice == "6":
                    break
                else:
                    print("Invalid option. Please select 1-6.")
                    
            except KeyboardInterrupt:
                print("\nExiting...")
                break
    
    input("\nPress Enter to exit...")

if __name__ == "__main__":
    main()
