import sys
import os
from pathlib import Path
from PyQt5.QtWidgets import QApplication
from PyQt5.QtCore import QObject, pyqtSignal, QThread

# Add the current directory to Python path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

# Import the VolatilityWorker class from process_manager_gui.py
from process_manager_gui import VolatilityWorker

class VolatilityTester(QObject):
    def __init__(self, dump_file):
        super().__init__()
        self.dump_file = Path(dump_file)
        self.worker = None
        self.app = QApplication.instance() or QApplication(sys.argv)
        
    def run_analysis(self):
        print(f"Starting Volatility analysis on: {self.dump_file}")
        
        # Create and configure the worker
        self.worker = VolatilityWorker(str(self.dump_file))
        self.worker.output_received.connect(self.handle_output)
        self.worker.finished.connect(self.analysis_finished)
        self.worker.threat_detected.connect(self.handle_threat)
        
        # Start the analysis in a separate thread
        self.worker.start()
        
        # Start the event loop
        self.app.exec_()
    
    def handle_output(self, text):
        print(text, end='')
    
    def handle_threat(self, threat_info):
        print("\n\n=== THREAT DETECTED ===")
        print(f"Severity: {threat_info.get('severity', 'Unknown')}")
        print(f"Type: {threat_info.get('type', 'Unknown')}")
        print(f"Description: {threat_info.get('description', 'No description')}")
        print("======================\n")
    
    def analysis_finished(self):
        print("\n\n=== ANALYSIS COMPLETE ===")
        self.app.quit()

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python test_volatility.py <path_to_dump_file>")
        sys.exit(1)
    
    dump_file = sys.argv[1]
    tester = VolatilityTester(dump_file)
    tester.run_analysis()
