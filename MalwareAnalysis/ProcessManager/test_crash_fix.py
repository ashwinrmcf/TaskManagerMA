#!/usr/bin/env python3

from rapid_volatility_test import RapidVolatilityAnalyzer
from pathlib import Path
from datetime import datetime

def test_crash_scenario():
    print("Testing forensic report generation crash scenario...")
    
    # Find dump file
    dump_dir = Path('F:/MalwareAnalysis/MemDump')
    dump_files = list(dump_dir.rglob('*.raw'))
    if dump_files:
        dump_file = max(dump_files, key=lambda f: f.stat().st_mtime)
        print(f"Using dump: {dump_file.name}")
    else:
        print("‚ùå No dump files found")
        return
    
    # Initialize analyzer
    analyzer = RapidVolatilityAnalyzer(dump_file, mode='simulated', fast_mode=True)
    
    # Create session directory
    session_dir = Path('F:/MalwareAnalysis/VolatilityAnalysis/CrashTest_Session')
    session_dir.mkdir(parents=True, exist_ok=True)
    
    # Create test threats similar to the crash scenario
    test_threats = [
        {
            'name': 'Nmap Network Scanner',
            'process': 'nmap.exe',
            'pid': 1234,
            'path': 'C:\\Tools\\nmap.exe',
            'type': 'Network Reconnaissance',
            'severity': 'MEDIUM',
            'classification': 'SUSPICIOUS',
            'description': 'Network scanning and enumeration activity'
        },
        {
            'name': 'Mimikatz Credential Harvester',
            'process': 'mimikatz.exe',
            'pid': 5678,
            'path': 'C:\\Temp\\mimikatz.exe',
            'type': 'Credential Theft',
            'severity': 'CRITICAL',
            'classification': 'DANGEROUS',
            'description': 'Active credential harvesting tool'
        }
    ]
    
    print("\nüìÅ Testing process-specific forensic report generation...")
    
    try:
        # This should now NOT crash
        process_folders = analyzer.generate_process_specific_reports(test_threats, session_dir)
        
        print(f"‚úÖ SUCCESS! Generated {len(process_folders)} folders without crashing:")
        for folder_info in process_folders:
            print(f"  üìÅ {folder_info['folder'].name}")
            if folder_info['folder'].exists():
                files = list(folder_info['folder'].iterdir())
                print(f"     Files: {len(files)}")
                for file in files:
                    print(f"       - {file.name}")
            else:
                print(f"     ‚ùå Folder not created")
        
        print("\nüéâ CRASH FIX SUCCESSFUL! GUI should no longer crash during forensic report generation.")
        
    except Exception as e:
        print(f"‚ùå STILL CRASHING: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    test_crash_scenario()
