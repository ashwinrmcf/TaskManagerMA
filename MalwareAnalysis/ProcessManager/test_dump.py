"""
Test script for memory dump functionality
"""
import sys
import os
from pathlib import Path
from PyQt5.QtWidgets import QApplication, QLabel, QVBoxLayout, QWidget, QPushButton
from PyQt5.QtCore import Qt

# Add the current directory to the Python path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
from countdown_dump_handler import CountdownDumpHandler, check_disk_space

class TestDumpWindow(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("Memory Dump Tester")
        self.setGeometry(100, 100, 400, 200)
        
        # Create UI
        self.status_label = QLabel("Click 'Start Dump' to begin testing the memory dump functionality.")
        self.status_label.setWordWrap(True)
        self.status_label.setAlignment(Qt.AlignCenter)
        
        self.start_button = QPushButton("Start Dump")
        self.start_button.clicked.connect(self.start_dump_test)
        
        # Layout
        layout = QVBoxLayout()
        layout.addWidget(self.status_label)
        layout.addWidget(self.start_button)
        self.setLayout(layout)
        
        # Initialize the dump handler
        self.dump_handler = CountdownDumpHandler(self)
        self.dump_handler.status_update.connect(self.update_status)
    
    def update_status(self, message):
        """Update the status label with the given message"""
        print(f"[STATUS] {message}")
        self.status_label.setText(message)
        QApplication.processEvents()  # Force UI update
    
    def start_dump_test(self):
        """Start the dump test"""
        self.start_button.setEnabled(False)
        self.status_label.setText("Starting dump test...")
        QApplication.processEvents()
        
        # Check disk space first
        dump_dir = Path(r"F:\MalwareAnalysis\MemDump")
        has_space, message = check_disk_space(dump_dir, 10)  # 10GB required
        
        if not has_space:
            self.status_label.setText(f"❌ {message}")
            self.start_button.setEnabled(True)
            return
        
        self.status_label.setText("✅ Disk space check passed. Starting dump process...")
        
        # Start the countdown which will trigger the dump after 10 seconds
        self.dump_handler.start_dump_countdown()
        
        # Re-enable the button after countdown starts
        self.start_button.setEnabled(True)

if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = TestDumpWindow()
    window.show()
    sys.exit(app.exec_())
