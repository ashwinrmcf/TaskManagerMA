#!/usr/bin/env python3
"""
Harmless Test Process for Malware Detection Testing
This program mimics suspicious behavior patterns to test the daemon console
COMPLETELY SAFE - Only for testing purposes
"""

import os
import sys
import time
import random
import threading
import subprocess
from datetime import datetime
import psutil

class SuspiciousTestProcess:
    """Harmless process that exhibits suspicious behavior patterns"""
    
    def __init__(self):
        self.running = True
        self.process_name = "suspicious_test_malware.exe"
        self.fake_pid = random.randint(2000, 9999)
        
    def high_cpu_activity(self):
        """Simulate high CPU usage"""
        print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸ”¥ Starting high CPU activity simulation...")
        
        while self.running:
            # Busy loop to consume CPU
            start_time = time.time()
            while time.time() - start_time < 2:  # 2 seconds of high CPU
                _ = sum(i * i for i in range(10000))
            
            time.sleep(1)  # Brief pause
    
    def suspicious_file_operations(self):
        """Simulate suspicious file operations"""
        print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸ“ Starting suspicious file operations...")
        
        test_dir = "F:/MalwareAnalysis/TestMalware"
        os.makedirs(test_dir, exist_ok=True)
        
        suspicious_files = [
            "ransom_note.txt",
            "encrypted_files.lock", 
            "trojan_payload.exe",
            "virus_signature.dat",
            "malware_config.ini"
        ]
        
        while self.running:
            try:
                # Create suspicious files
                for filename in suspicious_files:
                    filepath = os.path.join(test_dir, filename)
                    with open(filepath, 'w') as f:
                        f.write(f"TEST FILE - Created at {datetime.now()}\n")
                        f.write("This is a harmless test file for malware detection testing.\n")
                        f.write("SAFE - No actual malware content.\n")
                    
                    print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸ“„ Created suspicious file: {filename}")
                    time.sleep(2)
                
                # Delete and recreate (suspicious behavior)
                time.sleep(5)
                for filename in suspicious_files:
                    filepath = os.path.join(test_dir, filename)
                    if os.path.exists(filepath):
                        os.remove(filepath)
                        print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸ—‘ï¸ Deleted file: {filename}")
                
                time.sleep(10)
                
            except Exception as e:
                print(f"[ERROR] File operation failed: {e}")
                time.sleep(5)
    
    def suspicious_network_simulation(self):
        """Simulate suspicious network-like behavior"""
        print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸŒ Starting network activity simulation...")
        
        suspicious_domains = [
            "malware-command-control.test",
            "ransomware-payment.test", 
            "trojan-download.test",
            "virus-update.test"
        ]
        
        while self.running:
            try:
                domain = random.choice(suspicious_domains)
                port = random.choice([80, 443, 8080, 6667, 1337])
                
                print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸ”— Simulating connection to {domain}:{port}")
                print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸ“¡ Fake data transfer: {random.randint(100, 5000)} bytes")
                
                time.sleep(random.randint(5, 15))
                
            except Exception as e:
                print(f"[ERROR] Network simulation failed: {e}")
                time.sleep(5)
    
    def memory_intensive_operations(self):
        """Simulate memory-intensive operations"""
        print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸ’¾ Starting memory intensive operations...")
        
        memory_hogs = []
        
        while self.running:
            try:
                # Allocate memory chunks
                chunk = bytearray(10 * 1024 * 1024)  # 10MB chunks
                memory_hogs.append(chunk)
                
                current_memory = psutil.Process().memory_info().rss / 1024 / 1024  # MB
                print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸ“ˆ Memory usage: {current_memory:.1f} MB")
                
                # Keep only last 50 chunks (limit memory usage)
                if len(memory_hogs) > 50:
                    memory_hogs.pop(0)
                
                time.sleep(3)
                
            except Exception as e:
                print(f"[ERROR] Memory operation failed: {e}")
                time.sleep(5)
    
    def suspicious_process_spawning(self):
        """Simulate suspicious process spawning behavior"""
        print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸ”„ Starting process spawning simulation...")
        
        while self.running:
            try:
                # Simulate creating child processes (harmless)
                fake_processes = [
                    "crypto_miner.exe",
                    "keylogger.exe", 
                    "backdoor_service.exe",
                    "data_stealer.exe"
                ]
                
                process_name = random.choice(fake_processes)
                fake_child_pid = random.randint(3000, 8999)
                
                print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸ‘¶ Simulating spawn: {process_name} (PID: {fake_child_pid})")
                print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸ”— Parent-child relationship established")
                
                time.sleep(random.randint(8, 20))
                
            except Exception as e:
                print(f"[ERROR] Process simulation failed: {e}")
                time.sleep(5)
    
    def display_malicious_messages(self):
        """Display fake malicious messages"""
        print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸ’¬ Starting malicious message simulation...")
        
        fake_messages = [
            "ğŸ”’ Your files have been encrypted! (FAKE - This is a test)",
            "ğŸ’° Send payment to decrypt files (FAKE - This is a test)", 
            "ğŸš¨ System compromised - installing backdoor (FAKE - This is a test)",
            "ğŸ“¡ Sending data to command server (FAKE - This is a test)",
            "ğŸ”‘ Harvesting credentials (FAKE - This is a test)",
            "ğŸ¦  Virus replication in progress (FAKE - This is a test)"
        ]
        
        while self.running:
            try:
                message = random.choice(fake_messages)
                print(f"\n{'-'*60}")
                print(f"ğŸš¨ FAKE MALWARE MESSAGE: {message}")
                print(f"âš ï¸  THIS IS COMPLETELY HARMLESS - TESTING ONLY")
                print(f"{'-'*60}\n")
                
                time.sleep(random.randint(15, 30))
                
            except Exception as e:
                print(f"[ERROR] Message display failed: {e}")
                time.sleep(5)
    
    def run_test_malware(self):
        """Run the complete test malware simulation"""
        print(f"\n{'='*80}")
        print(f"ğŸ§ª HARMLESS MALWARE TEST PROCESS STARTED")
        print(f"{'='*80}")
        print(f"Process Name: {self.process_name}")
        print(f"Fake PID: {self.fake_pid}")
        print(f"Start Time: {datetime.now()}")
        print(f"Purpose: Testing Process Manager Daemon Console")
        print(f"Safety: 100% HARMLESS - No actual malware functionality")
        print(f"{'='*80}\n")
        
        # Start all suspicious behavior threads
        threads = [
            threading.Thread(target=self.high_cpu_activity, daemon=True),
            threading.Thread(target=self.suspicious_file_operations, daemon=True),
            threading.Thread(target=self.suspicious_network_simulation, daemon=True),
            threading.Thread(target=self.memory_intensive_operations, daemon=True),
            threading.Thread(target=self.suspicious_process_spawning, daemon=True),
            threading.Thread(target=self.display_malicious_messages, daemon=True)
        ]
        
        # Start all threads
        for thread in threads:
            thread.start()
            time.sleep(1)  # Stagger startup
        
        print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸš€ All suspicious behaviors activated!")
        print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸ“Š This process should now be detected by the daemon console")
        print(f"[{datetime.now().strftime('%H:%M:%S')}] â¹ï¸  Press Ctrl+C to stop the test")
        
        try:
            # Keep main thread alive
            while self.running:
                print(f"[{datetime.now().strftime('%H:%M:%S')}] â¤ï¸ Test malware heartbeat - still running...")
                time.sleep(30)
                
        except KeyboardInterrupt:
            print(f"\n[{datetime.now().strftime('%H:%M:%S')}] ğŸ›‘ Test stopped by user")
            self.running = False
            
        print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸ§¹ Cleaning up test files...")
        self.cleanup()
        print(f"[{datetime.now().strftime('%H:%M:%S')}] âœ… Test malware simulation ended")
    
    def cleanup(self):
        """Clean up test files"""
        try:
            test_dir = "F:/MalwareAnalysis/TestMalware"
            if os.path.exists(test_dir):
                import shutil
                shutil.rmtree(test_dir)
                print(f"[{datetime.now().strftime('%H:%M:%S')}] ğŸ—‘ï¸ Cleaned up test directory")
        except Exception as e:
            print(f"[ERROR] Cleanup failed: {e}")

def main():
    """Main entry point"""
    print("ğŸ§ª Harmless Malware Test Process")
    print("This program will exhibit suspicious behavior patterns to test your daemon console.")
    print("It is completely safe and will not harm your system in any way.")
    
    response = input("\nDo you want to start the test? (y/n): ").lower().strip()
    
    if response in ['y', 'yes']:
        test_process = SuspiciousTestProcess()
        test_process.run_test_malware()
    else:
        print("Test cancelled.")

if __name__ == "__main__":
    main()
