#!/usr/bin/env python3
"""
Emergency Backup Cleanup Script
Removes old emergency backups to free up disk space
"""

import os
import shutil
import time
from pathlib import Path

def cleanup_emergency_backups():
    """Clean up old emergency backups to free disk space"""
    
    emergency_dir = Path("f:/MalwareAnalysis/EMERGENCY_BACKUP")
    
    if not emergency_dir.exists():
        print("No emergency backup directory found.")
        return
    
    print(f"Scanning emergency backup directory: {emergency_dir}")
    
    # Find all backup directories
    backup_dirs = list(emergency_dir.glob("ProcessManager_backup_*"))
    
    if not backup_dirs:
        print("No backup directories found.")
        return
    
    print(f"Found {len(backup_dirs)} backup directories")
    
    # Sort by timestamp (newest first)
    backup_dirs.sort(key=lambda x: int(x.name.split('_')[-1]), reverse=True)
    
    # Keep only the 3 most recent backups
    keep_count = 3
    total_size_freed = 0
    deleted_count = 0
    
    for i, backup_dir in enumerate(backup_dirs):
        if i < keep_count:
            # Keep this backup
            try:
                size = sum(f.stat().st_size for f in backup_dir.rglob('*') if f.is_file())
                timestamp = int(backup_dir.name.split('_')[-1])
                age_hours = (time.time() - timestamp) / 3600
                print(f"KEEPING: {backup_dir.name} ({size/1024/1024:.1f} MB, {age_hours:.1f} hours old)")
            except Exception as e:
                print(f"KEEPING: {backup_dir.name} (size calculation failed: {e})")
        else:
            # Delete this backup
            try:
                size = sum(f.stat().st_size for f in backup_dir.rglob('*') if f.is_file())
                timestamp = int(backup_dir.name.split('_')[-1])
                age_hours = (time.time() - timestamp) / 3600
                
                shutil.rmtree(backup_dir)
                total_size_freed += size
                deleted_count += 1
                
                print(f"DELETED: {backup_dir.name} ({size/1024/1024:.1f} MB, {age_hours:.1f} hours old)")
                
            except Exception as e:
                print(f"ERROR deleting {backup_dir.name}: {e}")
    
    print(f"\nCleanup complete:")
    print(f"- Deleted {deleted_count} old backups")
    print(f"- Freed {total_size_freed/1024/1024:.1f} MB of disk space")
    print(f"- Kept {min(keep_count, len(backup_dirs))} most recent backups")

if __name__ == "__main__":
    print("Emergency Backup Cleanup Tool")
    print("=" * 40)
    cleanup_emergency_backups()
