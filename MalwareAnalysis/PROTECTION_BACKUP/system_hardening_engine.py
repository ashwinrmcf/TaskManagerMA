#!/usr/bin/env python3
"""
System Hardening Engine - Comprehensive system protection beyond process termination
Makes the system safer than the protection system itself
"""

import os
import sys
import time
import psutil
import threading
import subprocess
import ctypes
import winreg
import shutil
from pathlib import Path
from ctypes import wintypes, windll
from PyQt5.QtCore import QThread, pyqtSignal

class SystemHardeningEngine(QThread):
    """Comprehensive system hardening and protection engine"""
    
    system_threat_blocked = pyqtSignal(str, str)  # threat_type, details
    
    def __init__(self):
        super().__init__()
        self.running = True
        self.protected_directories = [
            r"C:\Windows\System32",
            r"C:\Windows\SysWOW64", 
            r"C:\Program Files",
            r"C:\Program Files (x86)",
            os.path.dirname(sys.executable)  # Python directory
        ]
        self.critical_files_backup = {}
        self.system_baseline = {}
        
    def run(self):
        """Main system hardening loop"""
        print("[SYSTEM-HARDENING] ðŸ›¡ï¸ SYSTEM HARDENING ENGINE ACTIVE")
        
        # Initialize system protection
        self.initialize_system_protection()
        
        while self.running:
            try:
                self.monitor_system_integrity()
                self.protect_critical_files()
                self.monitor_system_changes()
                self.enforce_security_policies()
                time.sleep(0.1)  # 100ms scan interval
                
            except Exception as e:
                print(f"[SYSTEM-HARDENING] Error: {e}")
                time.sleep(1)
    
    def initialize_system_protection(self):
        """Initialize comprehensive system protection"""
        print("[SYSTEM-HARDENING] Initializing system protection...")
        
        # Create system baseline
        self.create_system_baseline()
        
        # Backup critical files
        self.backup_critical_files()
        
        # Set security policies
        self.apply_security_policies()
        
        # Enable system monitoring
        self.enable_system_monitoring()
        
        print("[SYSTEM-HARDENING] âœ… System protection initialized")
    
    def create_system_baseline(self):
        """Create baseline of critical system components"""
        try:
            # Baseline critical registry keys
            critical_keys = [
                r"SOFTWARE\Microsoft\Windows\CurrentVersion\Run",
                r"SYSTEM\CurrentControlSet\Services",
                r"SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon"
            ]
            
            for key_path in critical_keys:
                try:
                    with winreg.OpenKey(winreg.HKEY_LOCAL_MACHINE, key_path) as key:
                        values = {}
                        i = 0
                        while True:
                            try:
                                name, value, _ = winreg.EnumValue(key, i)
                                values[name] = value
                                i += 1
                            except WindowsError:
                                break
                        self.system_baseline[key_path] = values
                except Exception as e:
                    pass
            
            print(f"[SYSTEM-HARDENING] Created baseline for {len(self.system_baseline)} registry keys")
            
        except Exception as e:
            print(f"[SYSTEM-HARDENING] Error creating baseline: {e}")
    
    def backup_critical_files(self):
        """Backup critical system files"""
        try:
            backup_dir = Path("F:/MalwareAnalysis/SYSTEM_BACKUP")
            backup_dir.mkdir(exist_ok=True)
            
            critical_files = [
                r"C:\Windows\System32\drivers\etc\hosts",
                r"C:\Windows\System32\kernel32.dll",
                r"C:\Windows\System32\ntdll.dll"
            ]
            
            for file_path in critical_files:
                if os.path.exists(file_path):
                    try:
                        backup_path = backup_dir / Path(file_path).name
                        shutil.copy2(file_path, backup_path)
                        self.critical_files_backup[file_path] = str(backup_path)
                        print(f"[SYSTEM-HARDENING] Backed up: {file_path}")
                    except Exception as e:
                        pass
            
        except Exception as e:
            print(f"[SYSTEM-HARDENING] Error backing up files: {e}")
    
    def apply_security_policies(self):
        """Apply comprehensive security policies"""
        try:
            # Disable dangerous Windows features
            self.disable_dangerous_features()
            
            # Set file permissions
            self.set_secure_permissions()
            
            # Configure Windows Defender
            self.configure_defender()
            
            print("[SYSTEM-HARDENING] âœ… Security policies applied")
            
        except Exception as e:
            print(f"[SYSTEM-HARDENING] Error applying policies: {e}")
    
    def disable_dangerous_features(self):
        """Disable dangerous Windows features"""
        try:
            dangerous_features = [
                # Disable PowerShell execution policy bypass
                ['powershell', '-Command', 'Set-ExecutionPolicy Restricted -Force'],
                # Disable Windows Script Host
                ['reg', 'add', 'HKLM\\SOFTWARE\\Microsoft\\Windows Script Host\\Settings', '/v', 'Enabled', '/t', 'REG_DWORD', '/d', '0', '/f'],
                # Disable autorun for removable drives
                ['reg', 'add', 'HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\Explorer', '/v', 'NoDriveTypeAutoRun', '/t', 'REG_DWORD', '/d', '255', '/f']
            ]
            
            for cmd in dangerous_features:
                try:
                    subprocess.run(cmd, capture_output=True, timeout=10)
                except:
                    pass
                    
        except Exception as e:
            pass
    
    def set_secure_permissions(self):
        """Set secure file permissions on critical directories"""
        try:
            for directory in self.protected_directories:
                if os.path.exists(directory):
                    try:
                        # Use icacls to set secure permissions
                        subprocess.run([
                            'icacls', directory, '/deny', 'Everyone:(OI)(CI)W'
                        ], capture_output=True, timeout=5)
                    except:
                        pass
        except Exception as e:
            pass
    
    def configure_defender(self):
        """Configure Windows Defender for maximum protection"""
        try:
            defender_commands = [
                # Enable real-time protection
                ['powershell', '-Command', 'Set-MpPreference -DisableRealtimeMonitoring $false'],
                # Enable cloud protection
                ['powershell', '-Command', 'Set-MpPreference -MAPSReporting Advanced'],
                # Enable automatic sample submission
                ['powershell', '-Command', 'Set-MpPreference -SubmitSamplesConsent SendAllSamples']
            ]
            
            for cmd in defender_commands:
                try:
                    subprocess.run(cmd, capture_output=True, timeout=10)
                except:
                    pass
                    
        except Exception as e:
            pass
    
    def enable_system_monitoring(self):
        """Enable comprehensive system monitoring"""
        try:
            # Enable process auditing
            subprocess.run([
                'auditpol', '/set', '/category:"Process Tracking"', '/success:enable', '/failure:enable'
            ], capture_output=True, timeout=5)
            
            # Enable logon auditing
            subprocess.run([
                'auditpol', '/set', '/category:"Logon/Logoff"', '/success:enable', '/failure:enable'
            ], capture_output=True, timeout=5)
            
        except Exception as e:
            pass
    
    def monitor_system_integrity(self):
        """Monitor system integrity continuously"""
        try:
            # Check for system file modifications
            self.check_system_files()
            
            # Monitor registry changes
            self.monitor_registry_changes()
            
            # Check for rootkit indicators
            self.detect_rootkits()
            
        except Exception as e:
            pass
    
    def check_system_files(self):
        """Check critical system files for modifications"""
        try:
            for file_path, backup_path in self.critical_files_backup.items():
                if os.path.exists(file_path) and os.path.exists(backup_path):
                    # Compare file hashes
                    if not self.files_match(file_path, backup_path):
                        self.system_threat_blocked.emit("FILE_MODIFICATION", f"Critical file modified: {file_path}")
                        self.restore_file(file_path, backup_path)
                        
        except Exception as e:
            pass
    
    def files_match(self, file1, file2):
        """Check if two files match"""
        try:
            import hashlib
            
            with open(file1, 'rb') as f1, open(file2, 'rb') as f2:
                hash1 = hashlib.md5(f1.read()).hexdigest()
                hash2 = hashlib.md5(f2.read()).hexdigest()
                return hash1 == hash2
                
        except Exception as e:
            return True  # Assume match if can't verify
    
    def restore_file(self, original_path, backup_path):
        """Restore file from backup"""
        try:
            shutil.copy2(backup_path, original_path)
            print(f"[SYSTEM-HARDENING] âœ… Restored: {original_path}")
            
        except Exception as e:
            print(f"[SYSTEM-HARDENING] Failed to restore {original_path}: {e}")
    
    def monitor_registry_changes(self):
        """Monitor registry for unauthorized changes"""
        try:
            for key_path, baseline in self.system_baseline.items():
                try:
                    with winreg.OpenKey(winreg.HKEY_LOCAL_MACHINE, key_path) as key:
                        current_values = {}
                        i = 0
                        while True:
                            try:
                                name, value, _ = winreg.EnumValue(key, i)
                                current_values[name] = value
                                i += 1
                            except WindowsError:
                                break
                        
                        # Check for unauthorized additions
                        for name, value in current_values.items():
                            if name not in baseline:
                                if self.is_malicious_registry_entry(name, value):
                                    self.system_threat_blocked.emit("REGISTRY_ATTACK", f"Malicious registry entry: {key_path}\\{name}")
                                    self.remove_registry_entry(key_path, name)
                                    
                except Exception as e:
                    pass
                    
        except Exception as e:
            pass
    
    def is_malicious_registry_entry(self, name, value):
        """Check if registry entry is malicious"""
        if not isinstance(value, str):
            return False
            
        value_lower = value.lower()
        malicious_indicators = [
            'temp', 'tmp', 'appdata\\roaming', 'programdata',
            'encrypt', 'crypto', 'ransom', 'backdoor', 'trojan'
        ]
        
        return any(indicator in value_lower for indicator in malicious_indicators)
    
    def remove_registry_entry(self, key_path, value_name):
        """Remove malicious registry entry"""
        try:
            with winreg.OpenKey(winreg.HKEY_LOCAL_MACHINE, key_path, 0, winreg.KEY_SET_VALUE) as key:
                winreg.DeleteValue(key, value_name)
                print(f"[SYSTEM-HARDENING] âœ… Removed malicious registry: {key_path}\\{value_name}")
                
        except Exception as e:
            pass
    
    def detect_rootkits(self):
        """Detect rootkit indicators"""
        try:
            # Check for hidden processes
            self.detect_hidden_processes()
            
            # Check for system call hooks
            self.detect_system_hooks()
            
        except Exception as e:
            pass
    
    def detect_hidden_processes(self):
        """Detect processes hidden by rootkits"""
        try:
            # Get process list from multiple sources
            psutil_pids = set(proc.pid for proc in psutil.process_iter())
            
            # Get PIDs from tasklist
            result = subprocess.run(['tasklist', '/fo', 'csv'], capture_output=True, text=True, timeout=5)
            tasklist_pids = set()
            
            if result.returncode == 0:
                lines = result.stdout.strip().split('\n')[1:]  # Skip header
                for line in lines:
                    try:
                        parts = line.split(',')
                        if len(parts) >= 2:
                            pid = int(parts[1].strip('"'))
                            tasklist_pids.add(pid)
                    except:
                        continue
            
            # Find discrepancies
            hidden_pids = tasklist_pids - psutil_pids
            if hidden_pids:
                self.system_threat_blocked.emit("ROOTKIT_DETECTION", f"Hidden processes detected: {hidden_pids}")
                
        except Exception as e:
            pass
    
    def detect_system_hooks(self):
        """Detect system call hooks"""
        try:
            # Check for common hook locations
            hook_locations = [
                'ntdll.dll',
                'kernel32.dll', 
                'user32.dll'
            ]
            
            for dll_name in hook_locations:
                if self.check_dll_hooks(dll_name):
                    self.system_threat_blocked.emit("SYSTEM_HOOK", f"Hooks detected in {dll_name}")
                    
        except Exception as e:
            pass
    
    def check_dll_hooks(self, dll_name):
        """Check if DLL has been hooked"""
        try:
            # Simple check for DLL integrity
            dll_path = os.path.join(r"C:\Windows\System32", dll_name)
            if os.path.exists(dll_path):
                # Check if file size is suspicious
                stat = os.stat(dll_path)
                # This is a simplified check - real implementation would be more complex
                return False
            return False
            
        except Exception as e:
            return False
    
    def protect_critical_files(self):
        """Actively protect critical files from modification"""
        try:
            for directory in self.protected_directories:
                if os.path.exists(directory):
                    # Monitor for unauthorized access attempts
                    self.monitor_directory_access(directory)
                    
        except Exception as e:
            pass
    
    def monitor_directory_access(self, directory):
        """Monitor directory for unauthorized access"""
        try:
            # Check for processes accessing protected directories
            for proc in psutil.process_iter(['pid', 'name', 'open_files']):
                try:
                    if proc.info['open_files']:
                        for file_info in proc.info['open_files']:
                            if file_info.path.startswith(directory):
                                # Check if process should have access
                                if self.is_unauthorized_access(proc.info, file_info.path):
                                    self.system_threat_blocked.emit("UNAUTHORIZED_ACCESS", 
                                        f"Process {proc.info['name']} accessing {file_info.path}")
                                    
                except (psutil.AccessDenied, psutil.NoSuchProcess):
                    continue
                    
        except Exception as e:
            pass
    
    def is_unauthorized_access(self, proc_info, file_path):
        """Check if file access is unauthorized"""
        try:
            proc_name = proc_info['name'].lower()
            
            # Allow system processes
            allowed_processes = {
                'system', 'csrss.exe', 'winlogon.exe', 'services.exe',
                'lsass.exe', 'svchost.exe', 'explorer.exe'
            }
            
            if proc_name in allowed_processes:
                return False
            
            # Check if process is from temp directory (suspicious)
            proc = psutil.Process(proc_info['pid'])
            try:
                exe_path = proc.exe().lower()
                if 'temp' in exe_path or 'tmp' in exe_path:
                    return True
            except:
                pass
            
            return False
            
        except Exception as e:
            return False
    
    def monitor_system_changes(self):
        """Monitor for system-level changes"""
        try:
            # Monitor service changes
            self.monitor_service_changes()
            
            # Monitor startup programs
            self.monitor_startup_changes()
            
            # Monitor network configuration
            self.monitor_network_changes()
            
        except Exception as e:
            pass
    
    def monitor_service_changes(self):
        """Monitor Windows services for changes"""
        try:
            # Get current services
            result = subprocess.run(['sc', 'query'], capture_output=True, text=True, timeout=10)
            if result.returncode == 0:
                # Parse service list and check for suspicious services
                lines = result.stdout.split('\n')
                for line in lines:
                    if 'SERVICE_NAME:' in line:
                        service_name = line.split(':')[1].strip()
                        if self.is_suspicious_service(service_name):
                            self.system_threat_blocked.emit("MALICIOUS_SERVICE", f"Suspicious service: {service_name}")
                            self.disable_service(service_name)
                            
        except Exception as e:
            pass
    
    def is_suspicious_service(self, service_name):
        """Check if service name is suspicious"""
        service_lower = service_name.lower()
        suspicious_patterns = [
            'encrypt', 'crypto', 'ransom', 'backdoor', 'trojan',
            'temp', 'tmp', 'malware', 'virus'
        ]
        
        return any(pattern in service_lower for pattern in suspicious_patterns)
    
    def disable_service(self, service_name):
        """Disable malicious service"""
        try:
            subprocess.run(['sc', 'stop', service_name], capture_output=True, timeout=5)
            subprocess.run(['sc', 'config', service_name, 'start=', 'disabled'], capture_output=True, timeout=5)
            print(f"[SYSTEM-HARDENING] âœ… Disabled malicious service: {service_name}")
            
        except Exception as e:
            pass
    
    def monitor_startup_changes(self):
        """Monitor startup program changes"""
        # Already handled in registry monitoring
        pass
    
    def monitor_network_changes(self):
        """Monitor network configuration changes"""
        try:
            # Check for suspicious network shares
            result = subprocess.run(['net', 'share'], capture_output=True, text=True, timeout=5)
            if result.returncode == 0:
                lines = result.stdout.split('\n')
                for line in lines:
                    if '$' not in line and 'C:\\' in line:  # Non-administrative shares
                        self.system_threat_blocked.emit("SUSPICIOUS_SHARE", f"Unauthorized network share: {line.strip()}")
                        
        except Exception as e:
            pass
    
    def enforce_security_policies(self):
        """Continuously enforce security policies"""
        try:
            # Re-apply critical security settings
            self.enforce_execution_policies()
            
            # Check for policy violations
            self.check_policy_violations()
            
        except Exception as e:
            pass
    
    def enforce_execution_policies(self):
        """Enforce execution policies"""
        try:
            # Ensure PowerShell execution policy is restricted
            subprocess.run([
                'powershell', '-Command', 'Set-ExecutionPolicy Restricted -Force'
            ], capture_output=True, timeout=5)
            
        except Exception as e:
            pass
    
    def check_policy_violations(self):
        """Check for security policy violations"""
        try:
            # Check if Windows Defender is disabled
            result = subprocess.run([
                'powershell', '-Command', 'Get-MpPreference | Select-Object DisableRealtimeMonitoring'
            ], capture_output=True, text=True, timeout=5)
            
            if 'True' in result.stdout:
                self.system_threat_blocked.emit("POLICY_VIOLATION", "Windows Defender real-time protection disabled")
                # Re-enable it
                subprocess.run([
                    'powershell', '-Command', 'Set-MpPreference -DisableRealtimeMonitoring $false'
                ], capture_output=True, timeout=5)
                
        except Exception as e:
            pass
    
    def stop_hardening(self):
        """Stop system hardening"""
        self.running = False

# Global system hardening instance
system_hardening_engine = None

def start_system_hardening():
    """Start system hardening engine"""
    global system_hardening_engine
    system_hardening_engine = SystemHardeningEngine()
    system_hardening_engine.start()
    return system_hardening_engine

def stop_system_hardening():
    """Stop system hardening engine"""
    global system_hardening_engine
    if system_hardening_engine:
        system_hardening_engine.stop_hardening()
        system_hardening_engine.quit()
        system_hardening_engine.wait(2000)
        system_hardening_engine = None
