#!/usr/bin/env python3
"""
Harmless Test Process - Simulates Suspicious Behavior for Testing
This script mimics malware-like patterns but is completely safe for testing.
"""

import time
import socket
import threading
import os
import sys
import subprocess
import hashlib
import random
from pathlib import Path

class SuspiciousTestProcess:
    def __init__(self):
        self.running = True
        self.connections = []
        self.suspicious_process_name = "malware_test.exe"  # Suspicious name
        print("[TEST-MALWARE] üß™ Starting harmless suspicious test process...")
        print("[TEST-MALWARE] This process simulates malware behavior for testing purposes")
        print("[TEST-MALWARE] üö® ALERT: This is a SUSPICIOUS PROCESS for testing!")
        print("[TEST-MALWARE] üîç Process name contains suspicious keywords")
        print("[TEST-MALWARE] üåê Will create network connections on suspicious ports")
        print("[TEST-MALWARE] üìÅ Will access system files and registry (simulated)")
        
    def simulate_network_activity(self):
        """Simulate suspicious network connections"""
        try:
            # Create a listening socket on a suspicious port
            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            sock.bind(('localhost', 4444))  # Suspicious port 4444
            sock.listen(1)
            self.connections.append(sock)
            print("[TEST-MALWARE] üåê Listening on suspicious port 4444")
            
            # Try to connect to external IP (will fail but creates network activity)
            try:
                external_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                external_sock.settimeout(2)
                external_sock.connect(('8.8.8.8', 80))  # Google DNS
                self.connections.append(external_sock)
                print("[TEST-MALWARE] üåç Connected to external IP")
            except:
                print("[TEST-MALWARE] üåç External connection failed (expected)")
                
        except Exception as e:
            print(f"[TEST-MALWARE] Network simulation error: {e}")
    
    def simulate_file_activity(self):
        """Simulate suspicious file access patterns"""
        try:
            # Create files in current directory (safer for testing)
            current_dir = Path.cwd()
            temp_dir = current_dir / "suspicious_test_files"
            temp_dir.mkdir(exist_ok=True)
            
            # Create suspicious files
            suspicious_files = [
                temp_dir / "keylogger.txt",
                temp_dir / "backdoor.txt", 
                temp_dir / "payload.exe.txt",
                temp_dir / "inject.dll.txt"
            ]
            
            for file_path in suspicious_files:
                with open(file_path, 'w') as f:
                    f.write("TEST FILE - This is a harmless test file simulating suspicious content")
                print(f"[TEST-MALWARE] üìÅ Created suspicious file: {file_path}")
                
        except Exception as e:
            print(f"[TEST-MALWARE] File simulation error: {e}")
    
    def simulate_memory_activity(self):
        """Simulate suspicious memory patterns"""
        try:
            # Create memory patterns that look suspicious
            suspicious_strings = [
                b"CreateRemoteThread",
                b"VirtualAllocEx", 
                b"WriteProcessMemory",
                b"SetWindowsHookEx",
                b"keylogger simulation test",
                b"backdoor simulation test",
                b"payload simulation test"
            ]
            
            # Keep these in memory
            self.memory_data = suspicious_strings
            print("[TEST-MALWARE] üß† Loaded suspicious strings into memory")
            
        except Exception as e:
            print(f"[TEST-MALWARE] Memory simulation error: {e}")
    
    def simulate_process_behavior(self):
        """Simulate suspicious process behavior"""
        try:
            # Consume some CPU to appear active
            for i in range(100):
                hash_data = hashlib.md5(str(i).encode()).hexdigest()
                time.sleep(0.01)
            
            print("[TEST-MALWARE] üíª Simulated CPU-intensive activity")
            
        except Exception as e:
            print(f"[TEST-MALWARE] Process simulation error: {e}")
    
    def run_simulation(self):
        """Run all suspicious behavior simulations"""
        print("[TEST-MALWARE] üöÄ Starting comprehensive malware simulation...")
        
        # Start network simulation in background
        network_thread = threading.Thread(target=self.simulate_network_activity)
        network_thread.daemon = True
        network_thread.start()
        
        # Run file activity simulation
        self.simulate_file_activity()
        
        # Run memory activity simulation
        self.simulate_memory_activity()
        
        # Run process behavior simulation
        self.simulate_process_behavior()
        
        print("[TEST-MALWARE] ‚úÖ All suspicious behaviors initialized")
        print("[TEST-MALWARE] üîÑ Entering main loop (will run until terminated)")
        print("[TEST-MALWARE] üìä This process should now appear suspicious to the analysis system")
        
        # Main loop - keep process alive for analysis
        counter = 0
        while self.running:
            try:
                # Periodic suspicious activity
                if counter % 10 == 0:
                    print(f"[TEST-MALWARE] üîÑ Still running... {counter} seconds")
                
                # Simulate some work
                data = f"suspicious_data_{counter}_{random.randint(1000, 9999)}"
                hash_result = hashlib.sha256(data.encode()).hexdigest()
                
                time.sleep(1)
                counter += 1
                
                # Auto-terminate after 10 minutes if not killed by system
                if counter > 600:
                    print("[TEST-MALWARE] ‚è∞ Auto-terminating after 10 minutes")
                    break
                    
            except KeyboardInterrupt:
                print("[TEST-MALWARE] üõë Received interrupt signal")
                break
            except Exception as e:
                print(f"[TEST-MALWARE] Error in main loop: {e}")
                break
    
    def cleanup(self):
        """Clean up resources"""
        try:
            self.running = False
            
            # Close network connections
            for conn in self.connections:
                try:
                    conn.close()
                except:
                    pass
            
            # Clean up test files
            current_dir = Path.cwd()
            temp_dir = current_dir / "suspicious_test_files"
            if temp_dir.exists():
                for file_path in temp_dir.glob("*"):
                    try:
                        file_path.unlink()
                    except:
                        pass
                try:
                    temp_dir.rmdir()
                except:
                    pass
            
            print("[TEST-MALWARE] üßπ Cleanup completed")
            
        except Exception as e:
            print(f"[TEST-MALWARE] Cleanup error: {e}")

def main():
    """Main function"""
    print("=" * 60)
    print("HARMLESS SUSPICIOUS PROCESS SIMULATOR")
    print("=" * 60)
    print("This script simulates malware behavior for testing purposes.")
    print("It is completely harmless and designed to test the analysis system.")
    print("The process will appear suspicious and should trigger analysis.")
    print("=" * 60)
    
    simulator = SuspiciousTestProcess()
    
    try:
        simulator.run_simulation()
    except Exception as e:
        print(f"[TEST-MALWARE] Main error: {e}")
    finally:
        simulator.cleanup()
        print("[TEST-MALWARE] üèÅ Test process terminated")

if __name__ == "__main__":
    main()
