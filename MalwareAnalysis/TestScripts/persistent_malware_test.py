#!/usr/bin/env python3
"""
PERSISTENT SUSPICIOUS TEST PROCESS - Runs Indefinitely
This simulates malware behavior for testing the detection and termination system.
"""

import time
import socket
import threading
import os
import sys
import random
import hashlib
from pathlib import Path

class PersistentMalwareTest:
    def __init__(self):
        self.running = True
        self.connections = []
        self.suspicious_data = []
        
        print("üö® [SUSPICIOUS-MALWARE] PERSISTENT THREAT DETECTED!")
        print("üö® [SUSPICIOUS-MALWARE] This is a MALICIOUS PROCESS simulation")
        print("üö® [SUSPICIOUS-MALWARE] Process name: malware_backdoor.exe")
        print("üö® [SUSPICIOUS-MALWARE] Network activity: SUSPICIOUS PORTS")
        print("üö® [SUSPICIOUS-MALWARE] File activity: KEYLOGGER FILES")
        print("üö® [SUSPICIOUS-MALWARE] Memory patterns: INJECTION SIGNATURES")
        
    def create_suspicious_network_activity(self):
        """Create persistent suspicious network connections"""
        try:
            # Listen on multiple suspicious ports
            for port in [4444, 6666, 8080, 9999]:
                try:
                    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
                    sock.bind(('localhost', port))
                    sock.listen(1)
                    self.connections.append(sock)
                    print(f"üåê [MALWARE] Listening on SUSPICIOUS port {port}")
                except:
                    pass
                    
            # Simulate beacon traffic
            while self.running:
                try:
                    # Simulate C2 beacon
                    beacon_sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                    beacon_sock.settimeout(1)
                    beacon_sock.connect(('8.8.8.8', 53))  # Suspicious DNS traffic
                    beacon_sock.close()
                    print("üåç [MALWARE] C2 beacon sent to external server")
                except:
                    pass
                time.sleep(5)
        except Exception as e:
            print(f"üåê [MALWARE] Network activity error: {e}")
    
    def create_suspicious_files(self):
        """Create and maintain suspicious files"""
        try:
            # Create suspicious directory
            mal_dir = Path("malware_files")
            mal_dir.mkdir(exist_ok=True)
            
            # Create multiple suspicious files
            suspicious_files = [
                "keylogger.exe", "backdoor.dll", "rootkit.sys", "stealer.bin",
                "ransomware.exe", "trojan.exe", "worm.scr", "virus.com"
            ]
            
            while self.running:
                for filename in suspicious_files:
                    try:
                        filepath = mal_dir / filename
                        with open(filepath, 'wb') as f:
                            # Write suspicious binary patterns
                            malicious_data = b"MALWARE_SIGNATURE_" + os.urandom(1024)
                            f.write(malicious_data)
                        print(f"üìÅ [MALWARE] Created malicious file: {filename}")
                    except:
                        pass
                time.sleep(10)
        except Exception as e:
            print(f"üìÅ [MALWARE] File creation error: {e}")
    
    def suspicious_memory_activity(self):
        """Simulate suspicious memory patterns"""
        try:
            while self.running:
                # Load suspicious strings into memory
                malware_strings = [
                    "KEYLOGGER_ACTIVE", "BACKDOOR_INSTALLED", "ROOTKIT_HIDDEN",
                    "C2_SERVER_CONTACT", "CREDENTIAL_HARVESTER", "PROCESS_INJECTION",
                    "PRIVILEGE_ESCALATION", "PERSISTENCE_MECHANISM"
                ]
                
                # Create suspicious memory patterns
                for i in range(100):
                    suspicious_block = (malware_strings[i % len(malware_strings)] * 1000).encode()
                    self.suspicious_data.append(suspicious_block)
                
                print("üß† [MALWARE] Loaded malicious payloads into memory")
                time.sleep(15)
        except Exception as e:
            print(f"üß† [MALWARE] Memory activity error: {e}")
    
    def cpu_intensive_malware_activity(self):
        """Simulate resource-intensive malware behavior"""
        try:
            while self.running:
                # Simulate cryptomining/brute force activity
                for _ in range(1000000):
                    hash_result = hashlib.sha256(os.urandom(32)).hexdigest()
                    if not self.running:
                        break
                
                print("üíª [MALWARE] Crypto-mining/brute-force activity completed")
                time.sleep(20)
        except Exception as e:
            print(f"üíª [MALWARE] CPU activity error: {e}")
    
    def run_persistent_malware(self):
        """Main malware execution loop"""
        print("üö® [MALWARE] STARTING PERSISTENT MALWARE EXECUTION...")
        print("üö® [MALWARE] This process will run INDEFINITELY until terminated")
        print("üö® [MALWARE] Process should be detected as HIGHLY SUSPICIOUS")
        
        # Start all malicious activities in separate threads
        # üî• NON-DAEMON THREADS - Process will stay alive until manually killed
        threads = [
            threading.Thread(target=self.create_suspicious_network_activity, daemon=False),
            threading.Thread(target=self.create_suspicious_files, daemon=False),
            threading.Thread(target=self.suspicious_memory_activity, daemon=False),
            threading.Thread(target=self.cpu_intensive_malware_activity, daemon=False)
        ]
        
        for thread in threads:
            thread.start()
        
        # Main execution loop - runs forever
        try:
            counter = 0
            while True:
                print(f"üö® [MALWARE] STILL ACTIVE - Runtime: {counter} minutes")
                print(f"üö® [MALWARE] Active network connections: {len(self.connections)}")
                print(f"üö® [MALWARE] Memory blocks allocated: {len(self.suspicious_data)}")
                print(f"üö® [MALWARE] STATUS: ACTIVELY MALICIOUS")
                print("=" * 60)
                
                time.sleep(60)  # Report every minute
                counter += 1
                
        except KeyboardInterrupt:
            print("üö® [MALWARE] Process terminated by user interrupt")
            self.cleanup()
        except Exception as e:
            print(f"üö® [MALWARE] Unexpected error: {e}")
            self.cleanup()
    
    def cleanup(self):
        """Clean up resources"""
        self.running = False
        for sock in self.connections:
            try:
                sock.close()
            except:
                pass
        print("üö® [MALWARE] Cleanup completed - process terminating")

if __name__ == "__main__":
    print("üö®" * 30)
    print("üö® PERSISTENT MALWARE TEST SIMULATION")
    print("üö® WARNING: This is a test process designed to appear malicious")
    print("üö® It will run INDEFINITELY until manually terminated")
    print("üö®" * 30)
    
    malware = PersistentMalwareTest()
    malware.run_persistent_malware()
